<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect â€“ Expert Schedule</title>
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; margin-bottom:20px; }
    .btn { background:#375432; color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer; }
    .btn:hover { background:#20301d; }
    .btn-outline { background:transparent; color:#375432; border:1.5px solid #375432; }
    .btn-outline:hover { background:#f0f7f0; }
    .btn-danger { background:#dc3545; }
    .btn-danger:hover { background:#c82333; }
    
    .stats-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px; }
    .stat-card { background:#f8f9fa; padding:15px; border-radius:8px; text-align:center; }
    .stat-number { font-size:1.8em; font-weight:700; color:#375432; }
    
    .tab-container { border-bottom:1px solid #ddd; margin-bottom:20px; }
    .tabs { display:flex; gap:10px; }
    .tab { padding:10px 15px; cursor:pointer; border-bottom:3px solid transparent; }
    .tab.active { border-bottom-color:#375432; font-weight:bold; }
    
    .calendar-container { display:flex; gap:20px; flex-wrap:wrap; }
    .calendar { flex:2; min-width:300px; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .calendar-title { font-size:1.2em; font-weight:600; margin:0; }
    .calendar-nav { display:flex; gap:10px; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .calendar-day-header { text-align:center; font-weight:600; padding:8px 0; color:#666; }
    .calendar-day { aspect-ratio:1/1; border:1px solid #ddd; border-radius:8px; display:flex; flex-direction:column; padding:5px; }
    .calendar-day:hover { background:#f0f7f0; }
    .calendar-day.today { background:#e9f5e9; border-color:#375432; }
    .calendar-day.selected { background:#375432; color:#fff; }
    .calendar-day.has-appointments { position:relative; }
    .calendar-day.has-appointments::after { content:''; position:absolute; bottom:5px; right:5px; width:8px; height:8px; background:#375432; border-radius:50%; }
    .calendar-day.other-month { opacity:0.4; }
    .calendar-day-number { font-weight:600; }
    .calendar-day-appointments { font-size:0.8em; margin-top:2px; }
    
    .appointments { flex:3; min-width:300px; }
    .appointment-list { max-height:500px; overflow-y:auto; }
    .appointment-item { padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .appointment-item:hover { background:#f9f9f9; }
    .appointment-info { flex:1; }
    .appointment-time { font-weight:600; color:#375432; }
    .appointment-farmer { margin-top:4px; font-size:0.9em; }
    .appointment-topic { color:#666; font-size:0.85em; margin-top:2px; }
    .appointment-status { padding:4px 8px; border-radius:12px; font-size:0.8em; margin-left:10px; }
    .status-confirmed { background:#d4edda; color:#155724; }
    .status-pending { background:#fff3cd; color:#856404; }
    .status-cancelled { background:#f8d7da; color:#721c24; }
    .status-completed { background:#d1ecf1; color:#0c5460; }
    .appointment-actions { display:flex; gap:8px; }
    
    .time-slots { margin-top:20px; }
    .time-slots-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .time-slots-title { font-size:1.1em; font-weight:600; margin:0; }
    .time-slots-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:10px; }
    .time-slot { padding:8px; border:1px solid #ddd; border-radius:6px; text-align:center; cursor:pointer; }
    .time-slot:hover { background:#f0f7f0; }
    .time-slot.available { background:#d4edda; border-color:#c3e6cb; }
    .time-slot.booked { background:#f8d7da; border-color:#f5c6cb; cursor:not-allowed; }
    
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:85vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; }
    .modal-title { font-size:1.5em; margin:0; }
    .close-btn { background:none; border:none; font-size:1.5em; cursor:pointer; }
    
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:1.5px solid #ddd; border-radius:6px; font-family:'Georgia', serif; }
    .form-group textarea { min-height:100px; resize:vertical; }
    
    .availability-settings { margin-top:20px; }
    .availability-day { display:flex; align-items:center; margin-bottom:10px; }
    .availability-day-name { width:100px; font-weight:600; }
    .availability-hours { display:flex; gap:10px; flex:1; }
    .availability-toggle { display:flex; align-items:center; }
    .toggle-switch { position:relative; display:inline-block; width:50px; height:24px; margin-right:10px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .toggle-slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px; }
    .toggle-slider:before { position:absolute; content:""; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%; }
    input:checked + .toggle-slider { background-color:#375432; }
    input:checked + .toggle-slider:before { transform:translateX(26px); }
    
    .empty-state { text-align:center; padding:40px 20px; color:#666; }
    .empty-state h3 { margin-top:0; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="page-head">
      <h1 style="margin:0;">Schedule</h1>
      <button class="btn" id="set-availability-btn">Set Availability</button>
    </div>

    <section class="card">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-number" id="total-appointments">0</div>
          <div>Total Appointments</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="upcoming-appointments">0</div>
          <div>Upcoming</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completed-appointments">0</div>
          <div>Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="available-slots">0</div>
          <div>Available Slots</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-view="calendar">Calendar View</div>
          <div class="tab" data-view="list">List View</div>
        </div>
      </div>

      <div id="calendar-view" class="view-container">
        <div class="calendar-container">
          <div class="calendar">
            <div class="calendar-header">
              <h3 class="calendar-title" id="calendar-month">January 2023</h3>
              <div class="calendar-nav">
                <button class="btn btn-outline" id="prev-month">Previous</button>
                <button class="btn btn-outline" id="next-month">Next</button>
              </div>
            </div>
            <div class="calendar-grid">
              <div class="calendar-day-header">Sun</div>
              <div class="calendar-day-header">Mon</div>
              <div class="calendar-day-header">Tue</div>
              <div class="calendar-day-header">Wed</div>
              <div class="calendar-day-header">Thu</div>
              <div class="calendar-day-header">Fri</div>
              <div class="calendar-day-header">Sat</div>
              <!-- Calendar days will be generated here -->
            </div>
          </div>

          <div class="appointments">
            <h3 id="selected-date">Appointments for January 1, 2023</h3>
            <div id="appointment-list" class="appointment-list">
              <!-- Appointments will be loaded here -->
            </div>

            <div class="time-slots">
              <div class="time-slots-header">
                <h4 class="time-slots-title">Available Time Slots</h4>
                <button class="btn btn-outline" id="add-slot-btn">+ Add Slot</button>
              </div>
              <div id="time-slots-grid" class="time-slots-grid">
                <!-- Time slots will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="list-view" class="view-container" style="display:none;">
        <div style="margin-bottom:15px;">
          <input type="text" id="search-input" placeholder="Search appointments..." style="padding:10px; width:300px; border-radius:6px; border:1.5px solid #ddd;">
          <select id="status-filter" style="padding:10px; border-radius:6px; border:1.5px solid #ddd; margin-left:10px;">
            <option value="all">All Statuses</option>
            <option value="confirmed">Confirmed</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div id="appointments-table-container">
          <table style="width:100%; border-collapse:collapse; border:1px solid #ddd;">
            <thead>
              <tr style="background:#f5f5f5;">
                <th style="padding:12px; text-align:left; border-bottom:1px solid #ddd;">Date & Time</th>
                <th style="padding:12px; text-align:left; border-bottom:1px solid #ddd;">Farmer</th>
                <th style="padding:12px; text-align:left; border-bottom:1px solid #ddd;">Topic</th>
                <th style="padding:12px; text-align:left; border-bottom:1px solid #ddd;">Status</th>
                <th style="padding:12px; text-align:left; border-bottom:1px solid #ddd;">Actions</th>
              </tr>
            </thead>
            <tbody id="appointments-table-body">
              <!-- Appointments will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Time Slot Modal -->
  <div id="slot-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="slot-modal-title">Add Time Slot</h2>
        <button class="close-btn">&times;</button>
      </div>
      <form id="slot-form">
        <input type="hidden" id="slot-id">
        <input type="hidden" id="slot-date">
        <div class="form-group">
          <label for="slot-start-time">Start Time</label>
          <input type="time" id="slot-start-time" required>
        </div>
        <div class="form-group">
          <label for="slot-end-time">End Time</label>
          <input type="time" id="slot-end-time" required>
        </div>
        <div class="form-group">
          <label for="slot-max-bookings">Maximum Bookings</label>
          <input type="number" id="slot-max-bookings" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label for="slot-notes">Notes (Optional)</label>
          <textarea id="slot-notes" placeholder="Any special instructions or notes for this time slot"></textarea>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="btn btn-outline" id="delete-slot-btn" style="display:none;">Delete</button>
          <button type="submit" class="btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Appointment Details Modal -->
  <div id="appointment-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="appointment-modal-title">Appointment Details</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div id="appointment-details">
        <!-- Appointment details will be loaded here -->
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
        <button class="btn btn-outline" id="cancel-appointment-btn">Cancel Appointment</button>
        <button class="btn" id="complete-appointment-btn">Mark as Completed</button>
      </div>
    </div>
  </div>

  <!-- Set Availability Modal -->
  <div id="availability-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Set Your Availability</h2>
        <button class="close-btn">&times;</button>
      </div>
      <form id="availability-form">
        <div class="availability-settings">
          <div class="availability-day">
            <div class="availability-day-name">Sunday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="sunday-toggle">
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="sunday-hours">
              <select id="sunday-start" disabled>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="sunday-end" disabled>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Monday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="monday-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="monday-hours">
              <select id="monday-start">
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="monday-end">
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Tuesday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="tuesday-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="tuesday-hours">
              <select id="tuesday-start">
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="tuesday-end">
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Wednesday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="wednesday-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="wednesday-hours">
              <select id="wednesday-start">
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="wednesday-end">
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Thursday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="thursday-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="thursday-hours">
              <select id="thursday-start">
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="thursday-end">
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Friday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="friday-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="friday-hours">
              <select id="friday-start">
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="friday-end">
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
          <div class="availability-day">
            <div class="availability-day-name">Saturday</div>
            <div class="availability-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="saturday-toggle">
                <span class="toggle-slider"></span>
              </label>
              <span>Available</span>
            </div>
            <div class="availability-hours" id="saturday-hours">
              <select id="saturday-start" disabled>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
              <span>to</span>
              <select id="saturday-end" disabled>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
                <option value="18:00" selected>6:00 PM</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-group" style="margin-top:20px;">
          <label for="appointment-duration">Default Appointment Duration (minutes)</label>
          <select id="appointment-duration">
            <option value="30">30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60" selected>60 minutes</option>
            <option value="90">90 minutes</option>
            <option value="120">120 minutes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="buffer-time">Buffer Time Between Appointments (minutes)</label>
          <select id="buffer-time">
            <option value="0">No buffer</option>
            <option value="5">5 minutes</option>
            <option value="10">10 minutes</option>
            <option value="15" selected>15 minutes</option>
            <option value="30">30 minutes</option>
          </select>
        </div>
        <div style="display:flex; justify-content:flex-end;">
          <button type="submit" class="btn">Save Availability</button>
        </div>
      </form>
    </div>
  </div>

  <div data-include="/components/footer.html"></div>

  <script>
    // State management
    const state = {
      currentDate: new Date(),
      selectedDate: new Date(),
      appointments: [],
      timeSlots: [],
      availability: {
        sunday: { available: false, start: '09:00', end: '18:00' },
        monday: { available: true, start: '09:00', end: '18:00' },
        tuesday: { available: true, start: '09:00', end: '18:00' },
        wednesday: { available: true, start: '09:00', end: '18:00' },
        thursday: { available: true, start: '09:00', end: '18:00' },
        friday: { available: true, start: '09:00', end: '18:00' },
        saturday: { available: false, start: '09:00', end: '18:00' },
        appointmentDuration: 60,
        bufferTime: 15
      }
    };

    // Helper functions
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    function formatTime(timeString) {
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${minutes} ${ampm}`;
    }

    function formatDateTime(dateTimeString) {
      const date = new Date(dateTimeString);
      return `${date.toLocaleDateString()} at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    function getDayName(date) {
      return date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    }

    // Storage functions
    function getAppointmentsKey(userId) {
      return `expert_appointments_${userId}`;
    }

    function getTimeSlotsKey(userId) {
      return `expert_time_slots_${userId}`;
    }

    function getAvailabilityKey(userId) {
      return `expert_availability_${userId}`;
    }

    function loadAppointments() {
      const user = getCurrentUser();
      if (!user) return [];
      
      const key = getAppointmentsKey(user.id);
      const raw = localStorage.getItem(key);
      try {
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveAppointments(appointments) {
      const user = getCurrentUser();
      if (!user) return;
      
      const key = getAppointmentsKey(user.id);
      localStorage.setItem(key, JSON.stringify(appointments));
    }

    function loadTimeSlots() {
      const user = getCurrentUser();
      if (!user) return [];
      
      const key = getTimeSlotsKey(user.id);
      const raw = localStorage.getItem(key);
      try {
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveTimeSlots(timeSlots) {
      const user = getCurrentUser();
      if (!user) return;
      
      const key = getTimeSlotsKey(user.id);
      localStorage.setItem(key, JSON.stringify(timeSlots));
    }

    function loadAvailability() {
      const user = getCurrentUser();
      if (!user) return state.availability;
      
      const key = getAvailabilityKey(user.id);
      const raw = localStorage.getItem(key);
      try {
        return raw ? JSON.parse(raw) : state.availability;
      } catch {
        return state.availability;
      }
    }

    function saveAvailability(availability) {
      const user = getCurrentUser();
      if (!user) return;
      
      const key = getAvailabilityKey(user.id);
      localStorage.setItem(key, JSON.stringify(availability));
    }

    // Initialize sample data
    function initSampleData() {
      const user = getCurrentUser();
      if (!user) return;
      
      const appointmentsKey = getAppointmentsKey(user.id);
      const timeSlotsKey = getTimeSlotsKey(user.id);
      const availabilityKey = getAvailabilityKey(user.id);
      
      // Only initialize if data doesn't exist
      if (!localStorage.getItem(appointmentsKey)) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);
        
        const sampleAppointments = [
          {
            id: 1,
            farmerId: 101,
            farmerName: 'Ravi Patel',
            farmerEmail: 'ravi.patel@example.com',
            farmerPhone: '9876543210',
            date: today.toISOString(),
            startTime: '10:00',
            endTime: '11:00',
            topic: 'Organic Pest Management',
            notes: 'Discussing natural solutions for aphid infestation in wheat crops',
            status: 'confirmed',
            createdAt: new Date(today.getTime() - 86400000).toISOString()
          },
          {
            id: 2,
            farmerId: 102,
            farmerName: 'Priya Sharma',
            farmerEmail: 'priya.sharma@example.com',
            farmerPhone: '9876543211',
            date: tomorrow.toISOString(),
            startTime: '14:00',
            endTime: '15:00',
            topic: 'Soil Health Assessment',
            notes: 'Review of soil test results and recommendations for improvement',
            status: 'pending',
            createdAt: new Date(today.getTime() - 172800000).toISOString()
          },
          {
            id: 3,
            farmerId: 103,
            farmerName: 'Ajay Kumar',
            farmerEmail: 'ajay.kumar@example.com',
            farmerPhone: '9876543212',
            date: nextWeek.toISOString(),
            startTime: '11:00',
            endTime: '12:00',
            topic: 'Crop Rotation Planning',
            notes: 'Seasonal planning for optimal crop rotation in mixed farming',
            status: 'confirmed',
            createdAt: new Date(today.getTime() - 259200000).toISOString()
          },
          {
            id: 4,
            farmerId: 104,
            farmerName: 'Meena Singh',
            farmerEmail: 'meena.singh@example.com',
            farmerPhone: '9876543213',
            date: new Date(today.getTime() - 86400000).toISOString(),
            startTime: '15:00',
            endTime: '16:00',
            topic: 'Water Conservation Techniques',
            notes: 'Discussion on drip irrigation implementation for vegetable farming',
            status: 'completed',
            createdAt: new Date(today.getTime() - 345600000).toISOString()
          }
        ];
        
        localStorage.setItem(appointmentsKey, JSON.stringify(sampleAppointments));
      }
      
      if (!localStorage.getItem(timeSlotsKey)) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const sampleTimeSlots = [
          {
            id: 1,
            date: today.toISOString(),
            startTime: '09:00',
            endTime: '10:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 2,
            date: today.toISOString(),
            startTime: '10:00',
            endTime: '11:00',
            maxBookings: 1,
            currentBookings: 1,
            notes: '',
            status: 'booked'
          },
          {
            id: 3,
            date: today.toISOString(),
            startTime: '11:00',
            endTime: '12:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 4,
            date: today.toISOString(),
            startTime: '14:00',
            endTime: '15:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 5,
            date: today.toISOString(),
            startTime: '15:00',
            endTime: '16:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 6,
            date: tomorrow.toISOString(),
            startTime: '09:00',
            endTime: '10:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 7,
            date: tomorrow.toISOString(),
            startTime: '10:00',
            endTime: '11:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          },
          {
            id: 8,
            date: tomorrow.toISOString(),
            startTime: '14:00',
            endTime: '15:00',
            maxBookings: 1,
            currentBookings: 1,
            notes: '',
            status: 'booked'
          },
          {
            id: 9,
            date: tomorrow.toISOString(),
            startTime: '15:00',
            endTime: '16:00',
            maxBookings: 1,
            currentBookings: 0,
            notes: '',
            status: 'available'
          }
        ];
        
        localStorage.setItem(timeSlotsKey, JSON.stringify(sampleTimeSlots));
      }
      
      if (!localStorage.getItem(availabilityKey)) {
        localStorage.setItem(availabilityKey, JSON.stringify(state.availability));
      }
    }

    // Calendar functions
    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      
      // Update calendar title
      document.getElementById('calendar-month').textContent = state.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      
      // Get first day of month and number of days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Clear previous calendar days
      const calendarGrid = document.querySelector('.calendar-grid');
      const dayHeaders = calendarGrid.querySelectorAll('.calendar-day-header');
      calendarGrid.innerHTML = '';
      
      // Add day headers back
      dayHeaders.forEach(header => {
        calendarGrid.appendChild(header);
      });
      
      // Add days from previous month
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = 0; i < startingDayOfWeek; i++) {
        const day = prevMonthLastDay - startingDayOfWeek + i + 1;
        const date = new Date(year, month - 1, day);
        addCalendarDay(date, 'other-month');
      }
      
      // Add days of current month
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, month, i);
        let classes = '';
        
        if (isSameDay(date, new Date())) {
          classes += ' today';
        }
        
        if (isSameDay(date, state.selectedDate)) {
          classes += ' selected';
        }
        
        // Check if day has appointments
        const hasAppointments = state.appointments.some(appointment => {
          const appointmentDate = new Date(appointment.date);
          return isSameDay(appointmentDate, date);
        });
        
        if (hasAppointments) {
          classes += ' has-appointments';
        }
        
        addCalendarDay(date, classes);
      }
      
      // Add days from next month
      const daysToAdd = 42 - (startingDayOfWeek + daysInMonth);
      for (let i = 1; i <= daysToAdd; i++) {
        const date = new Date(year, month + 1, i);
        addCalendarDay(date, 'other-month');
      }
    }

    function addCalendarDay(date, classes = '') {
      const calendarGrid = document.querySelector('.calendar-grid');
      const dayElement = document.createElement('div');
      dayElement.className = `calendar-day${classes ? ' ' + classes : ''}`;
      
      // Get appointments for this day
      const dayAppointments = state.appointments.filter(appointment => {
        const appointmentDate = new Date(appointment.date);
        return isSameDay(appointmentDate, date);
      });
      
      dayElement.innerHTML = `
        <div class="calendar-day-number">${date.getDate()}</div>
        ${dayAppointments.length > 0 ? `<div class="calendar-day-appointments">${dayAppointments.length} appt${dayAppointments.length > 1 ? 's' : ''}</div>` : ''}
      `;
      
      dayElement.addEventListener('click', () => {
        // Remove selected class from previously selected day
        document.querySelectorAll('.calendar-day.selected').forEach(day => {
          day.classList.remove('selected');
        });
        
        // Add selected class to clicked day
        dayElement.classList.add('selected');
        
        // Update selected date
        state.selectedDate = new Date(date);
        
        // Update appointments display
        updateSelectedDateDisplay();
        renderAppointmentsForSelectedDate();
        renderTimeSlotsForSelectedDate();
      });
      
      calendarGrid.appendChild(dayElement);
    }

    function updateSelectedDateDisplay() {
      document.getElementById('selected-date').textContent = `Appointments for ${formatDate(state.selectedDate)}`;
    }

    // Appointment functions
    function renderAppointmentsForSelectedDate() {
      const appointmentList = document.getElementById('appointment-list');
      
      // Filter appointments for selected date
      const dayAppointments = state.appointments.filter(appointment => {
        const appointmentDate = new Date(appointment.date);
        return isSameDay(appointmentDate, state.selectedDate);
      });
      
      // Sort appointments by time
      dayAppointments.sort((a, b) => {
        return a.startTime.localeCompare(b.startTime);
      });
      
      if (dayAppointments.length === 0) {
        appointmentList.innerHTML = `
          <div class="empty-state">
            <h3>No appointments for this day</h3>
            <p>Add time slots to allow farmers to book appointments.</p>
          </div>
        `;
        return;
      }
      
      appointmentList.innerHTML = dayAppointments.map(appointment => `
        <div class="appointment-item" data-id="${appointment.id}">
          <div class="appointment-info">
            <div class="appointment-time">${formatTime(appointment.startTime)} - ${formatTime(appointment.endTime)}</div>
            <div class="appointment-farmer">${appointment.farmerName}</div>
            <div class="appointment-topic">${appointment.topic}</div>
          </div>
          <span class="appointment-status status-${appointment.status}">${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}</span>
          <div class="appointment-actions">
            <button class="btn btn-outline" onclick="viewAppointment(${appointment.id})">View</button>
          </div>
        </div>
      `).join('');
    }

    function renderAppointmentsTable() {
      const tableBody = document.getElementById('appointments-table-body');
      const statusFilter = document.getElementById('status-filter').value;
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      
      // Filter appointments
      let filteredAppointments = [...state.appointments];
      
      if (statusFilter !== 'all') {
        filteredAppointments = filteredAppointments.filter(appointment => appointment.status === statusFilter);
      }
      
      if (searchTerm) {
        filteredAppointments = filteredAppointments.filter(appointment => {
          return appointment.farmerName.toLowerCase().includes(searchTerm) ||
                 appointment.topic.toLowerCase().includes(searchTerm);
        });
      }
      
      // Sort appointments by date and time
      filteredAppointments.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        if (dateA.getTime() !== dateB.getTime()) {
          return dateA - dateB;
        }
        return a.startTime.localeCompare(b.startTime);
      });
      
      if (filteredAppointments.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:20px;">
              <div class="empty-state">
                <h3>No appointments found</h3>
                <p>Try adjusting your filters or add new time slots.</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tableBody.innerHTML = filteredAppointments.map(appointment => {
        const appointmentDate = new Date(appointment.date);
        const formattedDate = appointmentDate.toLocaleDateString();
        
        return `
          <tr>
            <td style="padding:12px; border-bottom:1px solid #ddd;">
              ${formattedDate}<br>
              <span style="color:#666;">${formatTime(appointment.startTime)} - ${formatTime(appointment.endTime)}</span>
            </td>
            <td style="padding:12px; border-bottom:1px solid #ddd;">
              ${appointment.farmerName}<br>
              <span style="color:#666;">${appointment.farmerEmail}</span>
            </td>
            <td style="padding:12px; border-bottom:1px solid #ddd;">${appointment.topic}</td>
            <td style="padding:12px; border-bottom:1px solid #ddd;">
              <span class="appointment-status status-${appointment.status}" style="display:inline-block;">
                ${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}
              </span>
            </td>
            <td style="padding:12px; border-bottom:1px solid #ddd;">
              <button class="btn btn-outline" onclick="viewAppointment(${appointment.id})">View</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function viewAppointment(id) {
      const appointment = state.appointments.find(a => a.id === id);
      if (!appointment) return;
      
      const appointmentDate = new Date(appointment.date);
      const formattedDate = appointmentDate.toLocaleDateString();
      
      document.getElementById('appointment-details').innerHTML = `
        <div style="margin-bottom:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:1.1em; font-weight:600;">${appointment.topic}</div>
            <span class="appointment-status status-${appointment.status}">
              ${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}
            </span>
          </div>
          <div style="margin-bottom:5px;">
            <strong>Date:</strong> ${formattedDate}
          </div>
          <div style="margin-bottom:5px;">
            <strong>Time:</strong> ${formatTime(appointment.startTime)} - ${formatTime(appointment.endTime)}
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <h3 style="margin-top:0; margin-bottom:10px;">Farmer Information</h3>
          <div style="margin-bottom:5px;">
            <strong>Name:</strong> ${appointment.farmerName}
          </div>
          <div style="margin-bottom:5px;">
            <strong>Email:</strong> ${appointment.farmerEmail}
          </div>
          <div style="margin-bottom:5px;">
            <strong>Phone:</strong> ${appointment.farmerPhone}
          </div>
        </div>
        
        <div>
          <h3 style="margin-top:0; margin-bottom:10px;">Notes</h3>
          <p style="margin-top:0;">${appointment.notes || 'No notes provided.'}</p>
        </div>
      `;
      
      // Show/hide buttons based on appointment status
      const cancelBtn = document.getElementById('cancel-appointment-btn');
      const completeBtn = document.getElementById('complete-appointment-btn');
      
      if (appointment.status === 'completed' || appointment.status === 'cancelled') {
        cancelBtn.style.display = 'none';
        completeBtn.style.display = 'none';
      } else {
        cancelBtn.style.display = 'block';
        completeBtn.style.display = appointment.status === 'confirmed' ? 'block' : 'none';
        
        // Set up event listeners
        cancelBtn.onclick = () => cancelAppointment(appointment.id);
        completeBtn.onclick = () => completeAppointment(appointment.id);
      }
      
      // Show modal
      document.getElementById('appointment-modal').style.display = 'block';
    }

    function cancelAppointment(id) {
      if (confirm('Are you sure you want to cancel this appointment?')) {
        const index = state.appointments.findIndex(a => a.id === id);
        if (index !== -1) {
          state.appointments[index].status = 'cancelled';
          saveAppointments(state.appointments);
          
          // Update time slot status
          updateTimeSlotBookingStatus(state.appointments[index]);
          
          // Close modal and refresh views
          document.getElementById('appointment-modal').style.display = 'none';
          updateStats();
          renderCalendar();
          renderAppointmentsForSelectedDate();
          renderTimeSlotsForSelectedDate();
          renderAppointmentsTable();
          
          alert('Appointment cancelled successfully.');
        }
      }
    }

    function completeAppointment(id) {
      const index = state.appointments.findIndex(a => a.id === id);
      if (index !== -1) {
        state.appointments[index].status = 'completed';
        saveAppointments(state.appointments);
        
        // Close modal and refresh views
        document.getElementById('appointment-modal').style.display = 'none';
        updateStats();
        renderCalendar();
        renderAppointmentsForSelectedDate();
        renderTimeSlotsForSelectedDate();
        renderAppointmentsTable();
        
        alert('Appointment marked as completed.');
      }
    }

    // Time slot functions
    function renderTimeSlotsForSelectedDate() {
      const timeSlotsGrid = document.getElementById('time-slots-grid');
      
      // Filter time slots for selected date
      const dayTimeSlots = state.timeSlots.filter(slot => {
        const slotDate = new Date(slot.date);
        return isSameDay(slotDate, state.selectedDate);
      });
      
      // Sort time slots by time
      dayTimeSlots.sort((a, b) => {
        return a.startTime.localeCompare(b.startTime);
      });
      
      if (dayTimeSlots.length === 0) {
        timeSlotsGrid.innerHTML = `
          <div style="grid-column: 1/-1; text-align:center; padding:15px; color:#666;">
            No time slots available for this day.
          </div>
        `;
        return;
      }
      
      timeSlotsGrid.innerHTML = dayTimeSlots.map(slot => `
        <div class="time-slot ${slot.status}" data-id="${slot.id}">
          ${formatTime(slot.startTime)} - ${formatTime(slot.endTime)}
          ${slot.status === 'booked' ? `<div style="font-size:0.8em; margin-top:4px;">${slot.currentBookings}/${slot.maxBookings}</div>` : ''}
        </div>
      `).join('');
      
      // Add event listeners to time slots
      document.querySelectorAll('.time-slot').forEach(slotElement => {
        if (slotElement.classList.contains('available')) {
          slotElement.addEventListener('click', () => {
            const slotId = parseInt(slotElement.dataset.id);
            openSlotModal(slotId);
          });
        }
      });
    }

    function openSlotModal(id = null) {
      const modalTitle = document.getElementById('slot-modal-title');
      const slotForm = document.getElementById('slot-form');
      const slotIdInput = document.getElementById('slot-id');
      const slotDateInput = document.getElementById('slot-date');
      const startTimeInput = document.getElementById('slot-start-time');
      const endTimeInput = document.getElementById('slot-end-time');
      const maxBookingsInput = document.getElementById('slot-max-bookings');
      const notesInput = document.getElementById('slot-notes');
      const deleteBtn = document.getElementById('delete-slot-btn');
      
      // Reset form
      slotForm.reset();
      
      if (id) {
        // Edit existing slot
        const slot = state.timeSlots.find(s => s.id === id);
        if (!slot) return;
        
        modalTitle.textContent = 'Edit Time Slot';
        slotIdInput.value = slot.id;
        slotDateInput.value = state.selectedDate.toISOString();
        startTimeInput.value = slot.startTime;
        endTimeInput.value = slot.endTime;
        maxBookingsInput.value = slot.maxBookings;
        notesInput.value = slot.notes || '';
        
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = () => deleteTimeSlot(slot.id);
      } else {
        // Add new slot
        modalTitle.textContent = 'Add Time Slot';
        slotIdInput.value = '';
        slotDateInput.value = state.selectedDate.toISOString();
        
        // Set default times based on availability
        const dayName = getDayName(state.selectedDate);
        const dayAvailability = state.availability[dayName];
        
        if (dayAvailability && dayAvailability.available) {
          startTimeInput.value = dayAvailability.start;
          endTimeInput.value = dayAvailability.end;
        } else {
          startTimeInput.value = '09:00';
          endTimeInput.value = '10:00';
        }
        
        maxBookingsInput.value = 1;
        notesInput.value = '';
        
        deleteBtn.style.display = 'none';
      }
      
      // Show modal
      document.getElementById('slot-modal').style.display = 'block';
    }

    function saveTimeSlot(event) {
      event.preventDefault();
      
      const slotId = document.getElementById('slot-id').value;
      const slotDate = new Date(document.getElementById('slot-date').value);
      const startTime = document.getElementById('slot-start-time').value;
      const endTime = document.getElementById('slot-end-time').value;
      const maxBookings = parseInt(document.getElementById('slot-max-bookings').value);
      const notes = document.getElementById('slot-notes').value;
      
      // Validate inputs
      if (startTime >= endTime) {
        alert('End time must be after start time.');
        return;
      }
      
      if (maxBookings < 1) {
        alert('Maximum bookings must be at least 1.');
        return;
      }
      
      // Check for overlapping slots
      const overlappingSlot = state.timeSlots.find(slot => {
        const slotDate = new Date(slot.date);
        if (!isSameDay(slotDate, state.selectedDate)) return false;
        if (slotId && parseInt(slotId) === slot.id) return false; // Skip current slot when editing
        
        return (startTime < slot.endTime && endTime > slot.startTime);
      });
      
      if (overlappingSlot) {
        alert('This time slot overlaps with an existing slot.');
        return;
      }
      
      if (slotId) {
        // Update existing slot
        const index = state.timeSlots.findIndex(s => s.id === parseInt(slotId));
        if (index !== -1) {
          state.timeSlots[index] = {
            ...state.timeSlots[index],
            date: slotDate.toISOString(),
            startTime,
            endTime,
            maxBookings,
            notes
          };
        }
      } else {
        // Add new slot
        const newSlot = {
          id: Date.now(),
          date: slotDate.toISOString(),
          startTime,
          endTime,
          maxBookings,
          currentBookings: 0,
          notes,
          status: 'available'
        };
        
        state.timeSlots.push(newSlot);
      }
      
      // Save and refresh
      saveTimeSlots(state.timeSlots);
      document.getElementById('slot-modal').style.display = 'none';
      updateStats();
      renderTimeSlotsForSelectedDate();
    }

    function deleteTimeSlot(id) {
      if (confirm('Are you sure you want to delete this time slot?')) {
        const slot = state.timeSlots.find(s => s.id === id);
        if (!slot) return;
        
        // Check if slot has bookings
        if (slot.currentBookings > 0) {
          const hasConfirmedBookings = state.appointments.some(appointment => {
            const appointmentDate = new Date(appointment.date);
            const slotDate = new Date(slot.date);
            
            return isSameDay(appointmentDate, slotDate) &&
                   appointment.startTime === slot.startTime &&
                   appointment.status !== 'cancelled';
          });
          
          if (hasConfirmedBookings) {
            alert('Cannot delete this slot as it has confirmed bookings.');
            return;
          }
        }
        
        // Remove slot
        state.timeSlots = state.timeSlots.filter(s => s.id !== id);
        saveTimeSlots(state.timeSlots);
        
        // Close modal and refresh
        document.getElementById('slot-modal').style.display = 'none';
        updateStats();
        renderTimeSlotsForSelectedDate();
      }
    }

    function updateTimeSlotBookingStatus(appointment) {
      // Find matching time slot
      const matchingSlot = state.timeSlots.find(slot => {
        const slotDate = new Date(slot.date);
        const appointmentDate = new Date(appointment.date);
        
        return isSameDay(slotDate, appointmentDate) &&
               slot.startTime === appointment.startTime &&
               slot.endTime === appointment.endTime;
      });
      
      if (!matchingSlot) return;
      
      // Count active bookings for this slot
      const activeBookings = state.appointments.filter(a => {
        const aDate = new Date(a.date);
        const slotDate = new Date(matchingSlot.date);
        
        return isSameDay(aDate, slotDate) &&
               a.startTime === matchingSlot.startTime &&
               a.endTime === matchingSlot.endTime &&
               (a.status === 'confirmed' || a.status === 'pending');
      }).length;
      
      // Update slot status
      matchingSlot.currentBookings = activeBookings;
      matchingSlot.status = activeBookings >= matchingSlot.maxBookings ? 'booked' : 'available';
      
      saveTimeSlots(state.timeSlots);
    }

    // Availability functions
    function openAvailabilityModal() {
      // Load current availability settings
      for (const day in state.availability) {
        const dayData = state.availability[day];
        const toggle = document.getElementById(`${day}-toggle`);
        const startSelect = document.getElementById(`${day}-start`);
        const endSelect = document.getElementById(`${day}-end`);
        
        if (toggle && startSelect && endSelect) {
          toggle.checked = dayData.available;
          startSelect.value = dayData.start;
          endSelect.value = dayData.end;
          startSelect.disabled = !dayData.available;
          endSelect.disabled = !dayData.available;
        }
      }
      
      document.getElementById('appointment-duration').value = state.availability.appointmentDuration;
      document.getElementById('buffer-time').value = state.availability.bufferTime;
      
      // Show modal
      document.getElementById('availability-modal').style.display = 'block';
    }

    function saveAvailabilitySettings(event) {
      event.preventDefault();
      
      // Update availability for each day
      for (const day in state.availability) {
        const toggle = document.getElementById(`${day}-toggle`);
        const startSelect = document.getElementById(`${day}-start`);
        const endSelect = document.getElementById(`${day}-end`);
        
        if (toggle && startSelect && endSelect) {
          state.availability[day] = {
            available: toggle.checked,
            start: startSelect.value,
            end: endSelect.value
          };
        }
      }
      
      // Update other settings
      state.availability.appointmentDuration = document.getElementById('appointment-duration').value;
      state.availability.bufferTime = document.getElementById('buffer-time').value;
      
      // Save and close
      saveAvailability(state.availability);
      document.getElementById('availability-modal').style.display = 'none';
      
      // Refresh calendar
      renderCalendar();
      updateStats();
    }

    // Stats functions
    function updateStats() {
      const totalAppointments = state.appointments.length;
      const upcomingAppointments = state.appointments.filter(a => {
        const appointmentDate = new Date(a.date);
        const today = new Date();
        return (appointmentDate >= today && (a.status === 'confirmed' || a.status === 'pending'));
      }).length;
      const completedAppointments = state.appointments.filter(a => a.status === 'completed').length;
      const availableSlots = state.timeSlots.filter(s => s.status === 'available').length;
      
      document.getElementById('total-appointments').textContent = totalAppointments;
      document.getElementById('upcoming-appointments').textContent = upcomingAppointments;
      document.getElementById('completed-appointments').textContent = completedAppointments;
      document.getElementById('available-slots').textContent = availableSlots;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Page protection
      protectPage('expert');
      
      // Initialize data
      initSampleData();
      state.appointments = loadAppointments();
      state.timeSlots = loadTimeSlots();
      state.availability = loadAvailability();
      
      // Initialize calendar
      renderCalendar();
      updateSelectedDateDisplay();
      renderAppointmentsForSelectedDate();
      renderTimeSlotsForSelectedDate();
      updateStats();
      
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Show corresponding view
          const viewId = tab.dataset.view;
          document.querySelectorAll('.view-container').forEach(view => {
            view.style.display = view.id === `${viewId}-view` ? 'block' : 'none';
          });
          
          // Render appointments table if list view
          if (viewId === 'list') {
            renderAppointmentsTable();
          }
        });
      });
      
      // Calendar navigation
      document.getElementById('prev-month').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        renderCalendar();
      });
      
      document.getElementById('next-month').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        renderCalendar();
      });
      
      // Time slot form
      document.getElementById('slot-form').addEventListener('submit', saveTimeSlot);
      
      // Add slot button
      document.getElementById('add-slot-btn').addEventListener('click', () => openSlotModal());
      
      // Availability button
      document.getElementById('set-availability-btn').addEventListener('click', openAvailabilityModal);
      
      // Availability form
      document.getElementById('availability-form').addEventListener('submit', saveAvailabilitySettings);
      
      // Day availability toggles
      document.querySelectorAll('[id$="-toggle"]').forEach(toggle => {
        toggle.addEventListener('change', () => {
          const day = toggle.id.replace('-toggle', '');
          const startSelect = document.getElementById(`${day}-start`);
          const endSelect = document.getElementById(`${day}-end`);
          
          if (startSelect && endSelect) {
            startSelect.disabled = !toggle.checked;
            endSelect.disabled = !toggle.checked;
          }
        });
      });
      
      // Search and filter
      document.getElementById('search-input').addEventListener('input', renderAppointmentsTable);
      document.getElementById('status-filter').addEventListener('change', renderAppointmentsTable);
      
      // Close modals
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
          });
        });
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', event => {
        document.querySelectorAll('.modal').forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    });

    // Helper function to expose to global scope
    window.viewAppointment = viewAppointment;
  </script>
</body>
</html>