<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroConnect – Expert Messages</title>
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; }

    .compose { display:flex; gap:10px; flex-wrap: wrap; align-items:flex-end; }
    .compose select, .compose textarea { border:1.5px solid #86b691; border-radius:8px; padding:10px; background:#ffffff; font-size:1em; }
    .compose select { min-width: 220px; }
    .compose textarea { flex:1; min-height: 70px; resize: vertical; }
    .compose button { background:#375432; color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer; }
    .compose button:hover { background:#20301d; }

    .messages { margin-top:16px; }
    .msg-list { display:flex; flex-direction:column; gap:10px; max-height: 55vh; overflow:auto; padding-right:4px; }
    .msg { display:flex; gap:10px; }
    .msg.you { justify-content:flex-end; }
    .bubble { max-width: 70%; background:#e6fbe3; border:1px solid #98e59d; color:#25632a; padding:10px 12px; border-radius:12px; }
    .msg.you .bubble { background:#375432; color:#fff; border-color:#375432; }
    .meta { font-size:.78em; color:#6f7e6d; margin-top:4px; }
    .empty { text-align:center; color:#666; padding:28px 10px; }
    .contact-list { margin-bottom: 16px; }
    .contact-item { padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }
    .contact-item:hover { background: #f0f7f0; }
    .contact-item.active { background: #e6fbe3; }
    .contact-avatar { width: 40px; height: 40px; border-radius: 50%; background: #375432; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .contact-info { flex: 1; }
    .unread-badge { background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .tabs { display: flex; margin-bottom: 15px; }
    .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: #375432; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="page-head">
      <h1 style="margin:0;">Messages</h1>
    </div>

    <div style="display: flex; gap: 16px;">
      <section class="card" style="flex: 0 0 300px;">
        <div class="tabs">
          <div class="tab active" data-role="farmer" id="tab-farmers">Farmers</div>
          <div class="tab" data-role="consumer" id="tab-consumers">Consumers</div>
        </div>
        <div id="contact-list" class="contact-list"></div>
      </section>

      <div style="flex: 1; display: flex; flex-direction: column;">
        <section class="card">
          <h3 style="margin:0 0 10px 0;">New message</h3>
          <div class="compose">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:.95em;">
              Recipient
              <select id="recipient">
                <option value="">Select a recipient…</option>
              </select>
            </label>
            <label style="flex:1; display:flex; flex-direction:column; gap:6px; font-size:.95em;">
              Message
              <textarea id="messageText" placeholder="Type your message..."></textarea>
            </label>
            <button id="sendBtn">Send</button>
          </div>
        </section>

        <section class="messages card" style="margin-top:16px; flex: 1;">
          <h3 id="conversation-title" style="margin:0 0 10px 0;">Conversation</h3>
          <div id="messages" class="msg-list"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Shared footer -->
  <div data-include="/components/footer.html"></div>

  <script>
    const state = { 
      recipients: [], 
      user: null,
      selectedContact: null,
      contacts: [],
      activeTab: 'farmer' // Default to farmer tab
    };

    function messagesKey(userId){ return `expert_messages_${userId}`; }
    function loadMessages(){
      const raw = localStorage.getItem(messagesKey(state.user.id));
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function saveMessages(list){ localStorage.setItem(messagesKey(state.user.id), JSON.stringify(list)); }

    async function loadRecipients(){
      // Try local cache first
      let data = null;
      try { data = JSON.parse(localStorage.getItem('userData') || 'null'); } catch {}
      if(!data){
        try {
          const res = await fetch('/dataa.json');
          data = await res.json();
          localStorage.setItem('userData', JSON.stringify(data));
        } catch(e){ console.warn('Failed to load userData', e); }
      }
      
      // Create sample data if none exists
      if (!data || !data.users || data.users.length === 0) {
        const sampleFarmers = [
          { id: 201, name: 'Rajesh Kumar', role: 'farmer', location: 'Punjab' },
          { id: 202, name: 'Anita Singh', role: 'farmer', location: 'Haryana' },
          { id: 203, name: 'Vijay Patel', role: 'farmer', location: 'Gujarat' }
        ];
        
        const sampleConsumers = [
          { id: 101, name: 'Rahul Sharma', role: 'consumer', location: 'Delhi' },
          { id: 102, name: 'Priya Patel', role: 'consumer', location: 'Mumbai' },
          { id: 103, name: 'Amit Kumar', role: 'consumer', location: 'Bangalore' }
        ];
        
        state.recipients = [...sampleFarmers, ...sampleConsumers];
      } else {
        // Extract farmers and consumers from data
        const farmers = (data.users || []).filter(u => u.role === 'farmer');
        const consumers = (data.users || []).filter(u => u.role === 'consumer');
        const farmerDetails = data.farmers || [];
        const consumerDetails = data.consumers || [];
        
        const mapUsers = (users, details, role) => {
          return users.map(u => {
            const d = details.find(x => x.user_id === u.id);
            return { 
              id: u.id, 
              name: d?.full_name || u.username,
              role: role,
              location: d?.location || 'Unknown'
            };
          });
        };
        
        const mappedFarmers = mapUsers(farmers, farmerDetails, 'farmer');
        const mappedConsumers = mapUsers(consumers, consumerDetails, 'consumer');
        
        state.recipients = [...mappedFarmers, ...mappedConsumers];
      }
      
      updateRecipientDropdown();
      loadContactList();
    }
    
    function updateRecipientDropdown() {
      const filteredRecipients = state.recipients.filter(r => r.role === state.activeTab);
      const sel = document.getElementById('recipient');
      sel.innerHTML = '<option value="">Select a recipient…</option>' + 
        filteredRecipients.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    }
    
    function loadContactList() {
      const messages = loadMessages();
      const contactMap = new Map();
      
      // Filter recipients by active tab
      const filteredRecipients = state.recipients.filter(r => r.role === state.activeTab);
      
      // Group messages by contact
      messages.forEach(msg => {
        // Skip messages not related to the active tab role
        if (msg.toRole !== state.activeTab && msg.fromRole !== state.activeTab) return;
        
        const contactId = msg.fromId === state.user.id ? msg.toId : msg.fromId;
        const contactName = msg.fromId === state.user.id ? msg.toName : msg.fromName;
        const contactRole = msg.fromId === state.user.id ? msg.toRole : msg.fromRole;
        
        // Skip if not matching active tab
        if (contactRole !== state.activeTab) return;
        
        if (!contactMap.has(contactId)) {
          contactMap.set(contactId, {
            id: contactId,
            name: contactName,
            role: contactRole,
            messages: [],
            unread: 0
          });
        }
        
        const contact = contactMap.get(contactId);
        contact.messages.push(msg);
        
        // Count unread messages (from contact to expert)
        if (msg.fromId !== state.user.id && !msg.read) {
          contact.unread++;
        }
      });
      
      // Add contacts from recipients who don't have messages yet
      filteredRecipients.forEach(r => {
        if (!contactMap.has(r.id)) {
          contactMap.set(r.id, {
            id: r.id,
            name: r.name,
            role: r.role,
            location: r.location,
            messages: [],
            unread: 0
          });
        }
      });
      
      state.contacts = Array.from(contactMap.values());
      
      // Sort by most recent message
      state.contacts.sort((a, b) => {
        const aLatest = a.messages.length > 0 ? new Date(a.messages[a.messages.length - 1].ts) : new Date(0);
        const bLatest = b.messages.length > 0 ? new Date(b.messages[b.messages.length - 1].ts) : new Date(0);
        return bLatest - aLatest;
      });
      
      renderContactList();
    }
    
    function renderContactList() {
      const listEl = document.getElementById('contact-list');
      
      if (state.contacts.length === 0) {
        listEl.innerHTML = `<div class="empty">No ${state.activeTab}s available.</div>`;
        return;
      }
      
      listEl.innerHTML = state.contacts.map(contact => {
        const isActive = state.selectedContact && state.selectedContact.id === contact.id;
        const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
        
        return `<div class="contact-item ${isActive ? 'active' : ''}" data-id="${contact.id}">
          <div class="contact-avatar">${initials}</div>
          <div class="contact-info">
            <div>${contact.name}</div>
            <div style="font-size: 0.8em; color: #666;">${contact.location || ''} ${contact.messages.length > 0 ? '• Last: ' + new Date(contact.messages[contact.messages.length - 1].ts).toLocaleDateString() : ''}</div>
          </div>
          ${contact.unread > 0 ? `<div class="unread-badge">${contact.unread}</div>` : ''}
        </div>`;
      }).join('');
      
      // Add click handlers
      document.querySelectorAll('.contact-item').forEach(item => {
        item.addEventListener('click', () => {
          const contactId = parseInt(item.dataset.id, 10);
          selectContact(contactId);
        });
      });
    }
    
    function selectContact(contactId) {
      const contact = state.contacts.find(c => c.id === contactId);
      if (!contact) return;
      
      state.selectedContact = contact;
      document.getElementById('recipient').value = contact.id;
      document.getElementById('conversation-title').textContent = `Conversation with ${contact.name}`;
      
      // Mark messages as read
      const messages = loadMessages();
      let hasUnread = false;
      
      messages.forEach(msg => {
        if (msg.fromId === contact.id && !msg.read) {
          msg.read = true;
          hasUnread = true;
        }
      });
      
      if (hasUnread) {
        saveMessages(messages);
        loadContactList(); // Refresh contact list to update unread counts
      }
      
      renderContactList();
      renderMessages();
    }

    function renderMessages(){
      const box = document.getElementById('messages');
      let list = loadMessages();
      
      // Filter messages for selected contact if one is selected
      if (state.selectedContact) {
        list = list.filter(m => 
          (m.fromId === state.user.id && m.toId === state.selectedContact.id) || 
          (m.toId === state.user.id && m.fromId === state.selectedContact.id)
        );
      }
      
      list.sort((a,b)=> new Date(a.ts) - new Date(b.ts));
      
      if(list.length === 0){ 
        box.innerHTML = '<div class="empty">No messages yet. Start a conversation above.</div>'; 
        return; 
      }
      
      box.innerHTML = list.map(m => {
        const you = m.fromId === state.user.id;
        const to = you ? `To ${m.toName}` : `From ${m.fromName}`;
        return `<div class="msg ${you ? 'you':''}">
          <div class="bubble">
            <div>${m.text.replace(/</g,'&lt;')}</div>
            <div class="meta">${to} • ${new Date(m.ts).toLocaleString()}</div>
          </div>
        </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    }

    function sendMessage(){
      const sel = document.getElementById('recipient');
      const ta = document.getElementById('messageText');
      const toId = parseInt(sel.value, 10);
      const text = (ta.value || '').trim();
      if(!toId){ alert('Please choose a recipient'); return; }
      if(!text){ alert('Message cannot be empty'); return; }
      const to = state.recipients.find(r => r.id === toId);
      const list = loadMessages();
      const msg = {
        id: Date.now(),
        fromId: state.user.id,
        fromName: (state.user.details?.full_name) || state.user.username,
        fromRole: 'expert',
        toRole: to?.role || state.activeTab,
        toId,
        toName: to?.name || `Recipient ${toId}`,
        text,
        ts: new Date().toISOString(),
        read: true
      };
      list.push(msg);
      saveMessages(list);
      ta.value = '';
      
      // If this is a new contact, select them
      if (!state.selectedContact || state.selectedContact.id !== toId) {
        selectContact(toId);
      } else {
        renderMessages();
      }
      
      alert('Message sent successfully!');

      // Optional: simulate quick auto-reply
      setTimeout(()=>{
        const replies = {
          farmer: [
            "Thank you for your advice! I'll try implementing these techniques in my farm.",
            "I appreciate your expertise. Could you provide more details about sustainable farming methods?",
            "Thanks for the information. When would be a good time for a field consultation?"
          ],
          consumer: [
            "Thank you for your response! I'm interested in learning more about organic produce.",
            "I appreciate your insights. Do you have any articles about seasonal vegetables?",
            "Thanks for the information. I'd like to schedule a consultation about my home garden."
          ]
        };
        
        const randomReply = replies[to?.role || state.activeTab][Math.floor(Math.random() * replies[to?.role || state.activeTab].length)];
        
        const reply = {
          id: Date.now()+1,
          fromId: toId,
          fromName: msg.toName,
          fromRole: to?.role || state.activeTab,
          toRole: 'expert',
          toId: state.user.id,
          toName: msg.fromName,
          text: randomReply,
          ts: new Date().toISOString(),
          read: false
        };
        const l2 = loadMessages(); l2.push(reply); saveMessages(l2); 
        loadContactList(); // Refresh contact list with new message
        if (state.selectedContact && state.selectedContact.id === toId) {
          reply.read = true; // Mark as read immediately if we're viewing this conversation
          saveMessages(l2);
          renderMessages();
        }
      }, 800);
    }

    function switchTab(role) {
      state.activeTab = role;
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.role === role);
      });
      updateRecipientDropdown();
      loadContactList();
      
      // Clear selected contact when switching tabs
      state.selectedContact = null;
      document.getElementById('conversation-title').textContent = 'Conversation';
      renderMessages();
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      if(!protectPage('expert')) return;
      state.user = getCurrentUser();
      await loadRecipients();
      renderMessages();
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      
      // Add tab click handlers
      document.getElementById('tab-farmers').addEventListener('click', () => switchTab('farmer'));
      document.getElementById('tab-consumers').addEventListener('click', () => switchTab('consumer'));
      
      // Select first contact if available
      if (state.contacts.length > 0) {
        selectContact(state.contacts[0].id);
      }
    });
  </script>
</body>
</html>