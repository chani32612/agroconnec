<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroConnect – Supplier Catalog</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    :root { --green:#375432; --accent:#36b94a; --bg:#f7f6ea; }
    body { margin:0; font-family:'Georgia', serif; background:var(--bg); color:var(--green);}
    .container { max-width:1200px; margin:20px auto; padding:0 20px; }

    .action-row { display:flex; gap:12px; margin:16px 0 22px; justify-content:space-between; }
    .search-box { flex:1; display:flex; max-width:600px; }
    .search-box input { flex:1; padding:12px 14px; border:1.5px solid #86b691; border-radius:9px; font-size:1.05em; background:#fff; }
    .search-box button { background:#408a46;color:#fff;border:none;padding:10px 22px;border-radius:9px;font-size:1.02em;cursor:pointer;font-weight:600; }
    .add-product-btn { background:#2a7d32;color:#fff;border:none;padding:10px 22px;border-radius:9px;font-size:1.02em;cursor:pointer;font-weight:600; }

    .categories { display:flex; gap:16px; flex-wrap:wrap; margin: 12px 0 20px; }
    .category-card { background:#f6fff4; border:2px solid #d2fad1; color:#33823d; font-weight:600; border-radius:12px; padding:14px 16px; cursor:pointer; }
    .category-card.active { background:#33823d; color:#fff; border-color:#33823d; }
    
    .products-row { display:flex; gap:18px; flex-wrap:wrap; }
    .product-card { background:#fff; border-radius:14px; width:220px; box-shadow:0 2px 8px #17741014; padding:0 0 14px; display:flex; flex-direction:column; align-items:center; position:relative; }
    .product-card img { width:100%; height:120px; object-fit:cover; border-top-left-radius:14px; border-top-right-radius:14px; background:#f6fff4; }
    .product-desc { padding:10px 14px 0; text-align:center; width:100%; box-sizing:border-box; }
    .product-title { font-weight:700; margin-bottom:6px; }
    .product-price { color:var(--accent); font-weight:700; margin-bottom:6px; }
    .product-actions { display:flex; gap:8px; justify-content:center; margin-top:10px; }
    .edit-btn, .delete-btn { padding:7px 12px; border-radius:8px; font-size:0.9em; cursor:pointer; }
    .edit-btn { background:#e6fbe3; color:#25632a; border:1.4px solid #98e59d; }
    .delete-btn { background:#ffebee; color:#c62828; border:1.4px solid #ffcdd2; }
    .status-badge { position:absolute; top:10px; right:10px; padding:4px 8px; border-radius:12px; font-size:0.7em; font-weight:bold; }
    .status-available { background:#e6fbe3; color:#2e7d32; }
    .status-out-of-stock { background:#ffebee; color:#c62828; }
    
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:14px; width:90%; max-width:600px; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-header h2 { margin:0; }
    .close-btn { font-size:1.5em; cursor:pointer; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:10px; border:1.5px solid #86b691; border-radius:8px; font-size:1em; }
    .form-group textarea { min-height:100px; resize:vertical; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
    .cancel-btn { background:#f5f5f5; color:#333; border:1px solid #ddd; padding:10px 20px; border-radius:8px; cursor:pointer; }
    .save-btn { background:#2a7d32; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }

    @media (max-width: 700px) { 
      .products-row {flex-direction:column;} 
      .product-card {width:100%;} 
      .action-row {flex-direction:column;}
      .search-box {max-width:100%;}
    }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <h1 style="margin:10px 0 6px;">Manage Products</h1>

    <div class="action-row">
      <form class="search-box" onsubmit="event.preventDefault(); const v = this.querySelector('input').value.trim(); v ? searchProducts(v) : displayProducts();">
        <input placeholder="Search by name, category..." />
        <button type="submit"><i class="fas fa-search"></i> Search</button>
      </form>
      <button class="add-product-btn" onclick="openProductModal()"><i class="fas fa-plus"></i> Add Product</button>
    </div>

    <section class="categories">
      <div class="category-card active" onclick="filterProductsByCategory('all')">All</div>
      <div class="category-card" onclick="filterProductsByCategory('Vegetables')">Vegetables</div>
      <div class="category-card" onclick="filterProductsByCategory('Fruits')">Fruits</div>
      <div class="category-card" onclick="filterProductsByCategory('Dairy')">Dairy</div>
      <div class="category-card" onclick="filterProductsByCategory('Grains')">Grains</div>
      <div class="category-card" onclick="filterProductsByCategory('Seeds')">Seeds</div>
      <div class="category-card" onclick="filterProductsByCategory('Fertilizers')">Fertilizers</div>
      <div class="category-card" onclick="filterProductsByCategory('Equipment')">Equipment</div>
    </section>

    <h3 id="section-title">Your Products</h3>
    <div class="products-row"></div>
  </main>

  <!-- Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Product</h2>
        <span class="close-btn" onclick="closeProductModal()">&times;</span>
      </div>
      <form id="productForm" onsubmit="event.preventDefault(); saveProduct();">
        <input type="hidden" id="productId" value="" />
        <div class="form-group">
          <label for="productName">Product Name</label>
          <input type="text" id="productName" required />
        </div>
        <div class="form-group">
          <label for="productCategory">Category</label>
          <select id="productCategory" required>
            <option value="">Select a category</option>
            <option value="Vegetables">Vegetables</option>
            <option value="Fruits">Fruits</option>
            <option value="Dairy">Dairy</option>
            <option value="Grains">Grains</option>
            <option value="Seeds">Seeds</option>
            <option value="Fertilizers">Fertilizers</option>
            <option value="Equipment">Equipment</option>
          </select>
        </div>
        <div class="form-group">
          <label for="productDescription">Description</label>
          <textarea id="productDescription" required></textarea>
        </div>
        <div class="form-group">
          <label for="productPrice">Price (₹)</label>
          <input type="number" id="productPrice" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label for="productUnit">Unit</label>
          <select id="productUnit" required>
            <option value="kg">Kilogram (kg)</option>
            <option value="g">Gram (g)</option>
            <option value="piece">Piece</option>
            <option value="dozen">Dozen</option>
            <option value="liter">Liter</option>
            <option value="ml">Milliliter (ml)</option>
            <option value="packet">Packet</option>
          </select>
        </div>
        <div class="form-group">
          <label for="productQuantity">Available Quantity</label>
          <input type="number" id="productQuantity" min="0" required />
        </div>
        <div class="form-group">
          <label for="productImage">Image URL</label>
          <input type="text" id="productImage" placeholder="https://example.com/image.jpg" />
        </div>
        <div class="form-group">
          <label for="productStatus">Status</label>
          <select id="productStatus" required>
            <option value="available">Available</option>
            <option value="out_of_stock">Out of Stock</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="save-btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <div data-include="/components/footer.html"></div>

  <script>
    // Key for storing supplier products in localStorage
    const supplierProductsKey = () => {
      const currentUser = getCurrentUser();
      return currentUser ? `supplier_products_${currentUser.id}` : null;
    };

    // Load products from localStorage
    function loadProducts() {
      const key = supplierProductsKey();
      return key ? JSON.parse(localStorage.getItem(key) || '[]') : [];
    }

    // Save products to localStorage
    function saveProducts(products) {
      const key = supplierProductsKey();
      if (key) {
        localStorage.setItem(key, JSON.stringify(products));
      }
    }

    // Display all products
    function displayProducts() {
      const productsContainer = document.querySelector('.products-row');
      if (!productsContainer) return;
      
      const products = loadProducts();
      
      if (products.length === 0) {
        productsContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; width: 100%; color: #666;">
            <h3>No products added yet</h3>
            <p>Click the "Add Product" button to start adding products to your catalog!</p>
          </div>
        `;
        return;
      }
      
      // Sort products by creation date (newest first)
      products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      productsContainer.innerHTML = products.map(product => `
        <div class="product-card" data-product-id="${product.id}">
          <div class="status-badge status-${product.status === 'available' ? 'available' : 'out-of-stock'}">
            ${product.status === 'available' ? 'Available' : 'Out of Stock'}
          </div>
          <img src="${product.image_url || 'https://images.unsplash.com/photo-1560493676-04071c5f467b?w=300&h=200&fit=crop'}" 
               alt="${product.name}" 
               onerror="this.src='https://images.unsplash.com/photo-1560493676-04071c5f467b?w=300&h=200&fit=crop'"/>
          <div class="product-desc">
            <div class="product-title">${product.name}</div>
            <div class="product-price">₹${product.price} / ${product.unit}</div>
            <div style="font-size: 0.85em; color: #666; margin: 4px 0;">
              ${product.quantity} ${product.unit} available
            </div>
            <div style="font-size: 0.8em; color: #888; margin: 2px 0;">
              Category: ${product.category}
            </div>
            <div class="product-actions">
              <button class="edit-btn" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i> Edit</button>
              <button class="delete-btn" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('section-title').textContent = 'Your Products';
    }

    // Filter products by category
    function filterProductsByCategory(category) {
      const products = loadProducts();
      const filteredProducts = category === 'all' ? products : products.filter(p => 
        p.category.toLowerCase() === category.toLowerCase()
      );
      
      displayFilteredProducts(filteredProducts, category);

      // Update active category
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
        if (card.textContent.toLowerCase() === category.toLowerCase() || 
           (card.textContent === 'All' && category === 'all')) {
          card.classList.add('active');
        }
      });
    }

    // Display filtered products
    function displayFilteredProducts(products, category) {
      const productsContainer = document.querySelector('.products-row');
      if (!productsContainer) return;
      
      if (products.length === 0) {
        productsContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; width: 100%; color: #666;">
            <h3>No products found in ${category === 'all' ? 'your catalog' : 'the ' + category + ' category'}</h3>
            <p>Click the "Add Product" button to add products to your catalog!</p>
          </div>
        `;
        return;
      }
      
      productsContainer.innerHTML = products.map(product => `
        <div class="product-card" data-product-id="${product.id}">
          <div class="status-badge status-${product.status === 'available' ? 'available' : 'out-of-stock'}">
            ${product.status === 'available' ? 'Available' : 'Out of Stock'}
          </div>
          <img src="${product.image_url || 'https://images.unsplash.com/photo-1560493676-04071c5f467b?w=300&h=200&fit=crop'}" 
               alt="${product.name}" 
               onerror="this.src='https://images.unsplash.com/photo-1560493676-04071c5f467b?w=300&h=200&fit=crop'"/>
          <div class="product-desc">
            <div class="product-title">${product.name}</div>
            <div class="product-price">₹${product.price} / ${product.unit}</div>
            <div style="font-size: 0.85em; color: #666; margin: 4px 0;">
              ${product.quantity} ${product.unit} available
            </div>
            <div style="font-size: 0.8em; color: #888; margin: 2px 0;">
              Category: ${product.category}
            </div>
            <div class="product-actions">
              <button class="edit-btn" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i> Edit</button>
              <button class="delete-btn" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('section-title').textContent = category === 'all' ? 'Your Products' : `${category} Products`;
    }

    // Search products
    function searchProducts(searchTerm) {
      const products = loadProducts();
      const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        product.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        product.category.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      displayFilteredProducts(filteredProducts, 'search');
      
      // Update the heading to show search results
      document.getElementById('section-title').textContent = `Search Results for "${searchTerm}" (${filteredProducts.length} found)`;

      // Reset active category
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
        if (card.textContent === 'All') {
          card.classList.add('active');
        }
      });
    }

    // Open product modal for adding/editing
    function openProductModal(productId = null) {
      const modal = document.getElementById('productModal');
      const modalTitle = document.getElementById('modalTitle');
      const form = document.getElementById('productForm');
      
      // Reset form
      form.reset();
      document.getElementById('productId').value = '';
      
      if (productId) {
        // Edit existing product
        modalTitle.textContent = 'Edit Product';
        const products = loadProducts();
        const product = products.find(p => p.id === productId);
        
        if (product) {
          document.getElementById('productId').value = product.id;
          document.getElementById('productName').value = product.name;
          document.getElementById('productCategory').value = product.category;
          document.getElementById('productDescription').value = product.description;
          document.getElementById('productPrice').value = product.price;
          document.getElementById('productUnit').value = product.unit;
          document.getElementById('productQuantity').value = product.quantity;
          document.getElementById('productImage').value = product.image_url || '';
          document.getElementById('productStatus').value = product.status;
        }
      } else {
        // Add new product
        modalTitle.textContent = 'Add New Product';
      }
      
      modal.style.display = 'block';
    }

    // Close product modal
    function closeProductModal() {
      document.getElementById('productModal').style.display = 'none';
    }

    // Save product (add or update)
    function saveProduct() {
      const productId = document.getElementById('productId').value;
      const products = loadProducts();
      
      const productData = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value,
        price: parseFloat(document.getElementById('productPrice').value),
        unit: document.getElementById('productUnit').value,
        quantity: parseInt(document.getElementById('productQuantity').value),
        image_url: document.getElementById('productImage').value || null,
        status: document.getElementById('productStatus').value,
        supplier_id: getCurrentUser()?.id,
        updated_at: new Date().toISOString()
      };
      
      if (productId) {
        // Update existing product
        const index = products.findIndex(p => p.id === parseInt(productId));
        if (index !== -1) {
          productData.id = parseInt(productId);
          productData.created_at = products[index].created_at;
          products[index] = productData;
        }
      } else {
        // Add new product
        productData.id = Date.now();
        productData.created_at = new Date().toISOString();
        products.push(productData);
      }
      
      saveProducts(products);
      closeProductModal();
      displayProducts();
      
      // Show notification
      alert(productId ? 'Product updated successfully!' : 'Product added successfully!');
    }

    // Edit product
    function editProduct(productId) {
      openProductModal(productId);
    }

    // Delete product
    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        const products = loadProducts();
        const updatedProducts = products.filter(p => p.id !== productId);
        saveProducts(updatedProducts);
        displayProducts();
        alert('Product deleted successfully!');
      }
    }

    // Initialize with sample data if empty
    function initializeSampleData() {
      const products = loadProducts();
      if (products.length === 0) {
        const currentUser = getCurrentUser();
        const sampleProducts = [
          {
            id: 1001,
            name: 'Organic Fertilizer',
            category: 'Fertilizers',
            description: 'High-quality organic fertilizer for all types of crops. Improves soil health and increases yield.',
            price: 450,
            unit: 'kg',
            quantity: 100,
            image_url: 'https://images.unsplash.com/photo-1585314062604-1a357de8b000?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: currentUser?.id,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          },
          {
            id: 1002,
            name: 'Tomato Seeds',
            category: 'Seeds',
            description: 'High-yield tomato seeds resistant to common diseases. Perfect for both small and large farms.',
            price: 120,
            unit: 'packet',
            quantity: 50,
            image_url: 'https://images.unsplash.com/photo-1582515073490-39981397c445?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: currentUser?.id,
            created_at: new Date(Date.now() - 86400000).toISOString(),
            updated_at: new Date(Date.now() - 86400000).toISOString()
          },
          {
            id: 1003,
            name: 'Irrigation Drip Kit',
            category: 'Equipment',
            description: 'Complete drip irrigation kit for efficient water usage. Easy to install and maintain.',
            price: 1200,
            unit: 'piece',
            quantity: 15,
            image_url: 'https://images.unsplash.com/photo-1563514227147-6d2e624f82b8?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: currentUser?.id,
            created_at: new Date(Date.now() - 172800000).toISOString(),
            updated_at: new Date(Date.now() - 172800000).toISOString()
          }
        ];
        saveProducts(sampleProducts);
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      if (!protectPage('supplier')) return;
      
      // Initialize sample data if needed
      initializeSampleData();
      
      // Display products
      displayProducts();
      
      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById('productModal');
        if (event.target === modal) {
          closeProductModal();
        }
      };
    });
  </script>
</body>
</html>