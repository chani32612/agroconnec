<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect – Supplier Analytics</title>
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width:1100px; margin: 20px auto; padding: 0 20px; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; margin-bottom:20px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px; }
    .stat-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; text-align:center; }
    .stat-number { font-size:2em; font-weight:700; color:#375432; margin:10px 0; }
    .stat-label { color:#666; font-size:0.9em; }
    .chart-container { height:300px; margin-bottom:20px; }
    .chart-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap:20px; margin-bottom:20px; }
    .filter-tabs { display:flex; gap:10px; margin: 10px 0 18px; flex-wrap:wrap; }
    .filter-tab { background:#fff; border:2px solid #375432; color:#375432; padding:.45rem .8rem; border-radius:8px; cursor:pointer; }
    .filter-tab.active { background:#375432; color:#fff; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; font-weight: 600; }
    tr:hover { background-color: #f5f5f5; }
    .status-delivered { color: #2e7d32; }
    .status-processing { color: #1976d2; }
    .status-pending { color: #ed6c02; }
    .status-cancelled { color: #d32f2f; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="page-head">
      <h1 style="margin:0;">Supplier Analytics</h1>
      <div class="filter-tabs">
        <div class="filter-tab active" data-period="week">This Week</div>
        <div class="filter-tab" data-period="month">This Month</div>
        <div class="filter-tab" data-period="year">This Year</div>
        <div class="filter-tab" data-period="all">All Time</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-number" id="total-revenue">₹0</div>
        <div class="stat-trend">+15% from last period</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Orders</div>
        <div class="stat-number" id="total-orders">0</div>
        <div class="stat-trend">+8% from last period</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Products</div>
        <div class="stat-number" id="total-products">0</div>
        <div class="stat-trend">+3 new this period</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Farmers Served</div>
        <div class="stat-number" id="total-farmers">0</div>
        <div class="stat-trend">+2 new this period</div>
      </div>
    </div>

    <div class="chart-row">
      <div class="card">
        <h3>Revenue Trend</h3>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3>Top Products</h3>
        <div class="chart-container">
          <canvas id="products-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-row">
      <div class="card">
        <h3>Customer Distribution</h3>
        <div class="chart-container">
          <canvas id="customer-chart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3>Order Status</h3>
        <div class="chart-container">
          <canvas id="status-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Recent Orders</h3>
      <div class="table-container">
        <table id="recent-orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Farmer</th>
              <th>Products</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    let currentPeriod = 'week';
    let revenueChart, productsChart, customerChart, statusChart;
    
    function getOrders() {
      const user = getCurrentUser();
      if (!user) return [];
      return JSON.parse(localStorage.getItem(`supplier_orders_${user.id}`) || '[]');
    }
    
    function getProducts() {
      const user = getCurrentUser();
      if (!user) return [];
      return JSON.parse(localStorage.getItem(`supplier_products_${user.id}`) || '[]');
    }
    
    function getFarmers() {
      // In a real app, this would fetch actual farmer data
      // For demo, we'll extract unique farmers from orders
      const orders = getOrders();
      const uniqueFarmers = new Set(orders.map(o => o.farmerId));
      return Array.from(uniqueFarmers).map(id => {
        const order = orders.find(o => o.farmerId === id);
        return {
          id,
          name: order?.farmerName || `Farmer ${id}`,
          location: order?.farmerLocation || 'Unknown',
          orderCount: orders.filter(o => o.farmerId === id).length,
          totalSpent: orders.filter(o => o.farmerId === id).reduce((sum, o) => sum + o.total, 0)
        };
      });
    }
    
    function filterDataByPeriod(data, dateField) {
      const now = new Date();
      let startDate;
      
      switch(currentPeriod) {
        case 'week':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          break;
        case 'year':
          startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
          break;
        case 'all':
        default:
          return data; // No filtering for all time
      }
      
      return data.filter(item => new Date(item[dateField]) >= startDate);
    }
    
    function updateStats() {
      const orders = filterDataByPeriod(getOrders(), 'orderDate');
      const products = getProducts();
      const farmers = getFarmers();
      
      // Update summary stats
      document.getElementById('total-revenue').textContent = `₹${orders.reduce((sum, o) => sum + o.total, 0).toFixed(0)}`;
      document.getElementById('total-orders').textContent = orders.length;
      document.getElementById('total-products').textContent = products.length;
      document.getElementById('total-farmers').textContent = farmers.length;
      
      // Update recent orders table
      const tableBody = document.querySelector('#recent-orders-table tbody');
      tableBody.innerHTML = orders
        .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
        .slice(0, 5) // Show only 5 most recent orders
        .map(order => `
          <tr>
            <td>#${order.id}</td>
            <td>${new Date(order.orderDate).toLocaleDateString()}</td>
            <td>${order.farmerName}</td>
            <td>${order.items.length} items</td>
            <td>₹${order.total.toFixed(0)}</td>
            <td><span class="status-${order.status.toLowerCase()}">${order.status[0].toUpperCase() + order.status.slice(1)}</span></td>
          </tr>
        `).join('');
      
      updateCharts(orders, products, farmers);
    }
    
    function updateCharts(orders, products, farmers) {
      // Prepare data for revenue chart (last 7 days/weeks/months based on period)
      const revenueData = prepareRevenueData(orders);
      
      // Update revenue trend chart
      if (revenueChart) revenueChart.destroy();
      revenueChart = new Chart(document.getElementById('revenue-chart'), {
        type: 'line',
        data: {
          labels: revenueData.labels,
          datasets: [{
            label: 'Revenue (₹)',
            data: revenueData.data,
            borderColor: '#2e7d32',
            backgroundColor: 'rgba(46, 125, 50, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '₹' + value;
                }
              }
            }
          }
        }
      });
      
      // Update top products chart
      const productData = prepareProductData(orders, products);
      if (productsChart) productsChart.destroy();
      productsChart = new Chart(document.getElementById('products-chart'), {
        type: 'bar',
        data: {
          labels: productData.labels,
          datasets: [{
            label: 'Units Sold',
            data: productData.data,
            backgroundColor: [
              'rgba(46, 125, 50, 0.7)',
              'rgba(56, 142, 60, 0.7)',
              'rgba(67, 160, 71, 0.7)',
              'rgba(76, 175, 80, 0.7)',
              'rgba(129, 199, 132, 0.7)'
            ],
            borderColor: [
              'rgba(46, 125, 50, 1)',
              'rgba(56, 142, 60, 1)',
              'rgba(67, 160, 71, 1)',
              'rgba(76, 175, 80, 1)',
              'rgba(129, 199, 132, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Update customer distribution chart
      const customerData = prepareCustomerData(farmers);
      if (customerChart) customerChart.destroy();
      customerChart = new Chart(document.getElementById('customer-chart'), {
        type: 'pie',
        data: {
          labels: customerData.labels,
          datasets: [{
            data: customerData.data,
            backgroundColor: [
              'rgba(46, 125, 50, 0.7)',
              'rgba(56, 142, 60, 0.7)',
              'rgba(67, 160, 71, 0.7)',
              'rgba(76, 175, 80, 0.7)',
              'rgba(129, 199, 132, 0.7)'
            ],
            borderColor: [
              'rgba(46, 125, 50, 1)',
              'rgba(56, 142, 60, 1)',
              'rgba(67, 160, 71, 1)',
              'rgba(76, 175, 80, 1)',
              'rgba(129, 199, 132, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Update order status chart
      const statusData = prepareStatusData(orders);
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(document.getElementById('status-chart'), {
        type: 'doughnut',
        data: {
          labels: statusData.labels,
          datasets: [{
            data: statusData.data,
            backgroundColor: [
              'rgba(46, 125, 50, 0.7)',  // Delivered
              'rgba(25, 118, 210, 0.7)',  // Processing
              'rgba(237, 108, 2, 0.7)',   // Pending
              'rgba(211, 47, 47, 0.7)'    // Cancelled
            ],
            borderColor: [
              'rgba(46, 125, 50, 1)',
              'rgba(25, 118, 210, 1)',
              'rgba(237, 108, 2, 1)',
              'rgba(211, 47, 47, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    }
    
    function prepareRevenueData(orders) {
      const labels = [];
      const data = [];
      const dateFormat = { week: 'day', month: 'week', year: 'month', all: 'month' }[currentPeriod];
      
      // Generate date labels based on current period
      const now = new Date();
      let startDate;
      let format;
      
      switch(currentPeriod) {
        case 'week':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6);
          format = { weekday: 'short' };
          for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            labels.push(date.toLocaleDateString('en-US', format));
            
            // Sum orders for this day
            const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1);
            const dayOrders = orders.filter(o => {
              const orderDate = new Date(o.orderDate);
              return orderDate >= dayStart && orderDate < dayEnd;
            });
            data.push(dayOrders.reduce((sum, o) => sum + o.total, 0));
          }
          break;
          
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
          for (let i = 1; i <= lastDay; i += 7) {
            const weekEnd = Math.min(i + 6, lastDay);
            labels.push(`${i}-${weekEnd}`);
            
            // Sum orders for this week
            const weekStart = new Date(now.getFullYear(), now.getMonth(), i);
            const weekEndDate = new Date(now.getFullYear(), now.getMonth(), weekEnd + 1);
            const weekOrders = orders.filter(o => {
              const orderDate = new Date(o.orderDate);
              return orderDate >= weekStart && orderDate < weekEndDate;
            });
            data.push(weekOrders.reduce((sum, o) => sum + o.total, 0));
          }
          break;
          
        case 'year':
        case 'all':
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          for (let i = 0; i < 12; i++) {
            const month = (now.getMonth() - 11 + i + 12) % 12;
            const year = now.getFullYear() - (month > now.getMonth() ? 1 : 0);
            labels.push(monthNames[month]);
            
            // Sum orders for this month
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 1);
            const monthOrders = orders.filter(o => {
              const orderDate = new Date(o.orderDate);
              return orderDate >= monthStart && orderDate < monthEnd;
            });
            data.push(monthOrders.reduce((sum, o) => sum + o.total, 0));
          }
          break;
      }
      
      return { labels, data };
    }
    
    function prepareProductData(orders, products) {
      // Count product occurrences in orders
      const productCounts = {};
      orders.forEach(order => {
        order.items.forEach(item => {
          if (!productCounts[item.productId]) {
            productCounts[item.productId] = 0;
          }
          productCounts[item.productId] += item.quantity;
        });
      });
      
      // Sort products by count and take top 5
      const sortedProducts = Object.entries(productCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      // Map product IDs to names
      const labels = sortedProducts.map(([id]) => {
        const product = products.find(p => p.id === parseInt(id));
        return product ? product.name : `Product ${id}`;
      });
      
      const data = sortedProducts.map(([, count]) => count);
      
      return { labels, data };
    }
    
    function prepareCustomerData(farmers) {
      // Group farmers by location
      const locationCounts = {};
      farmers.forEach(farmer => {
        if (!locationCounts[farmer.location]) {
          locationCounts[farmer.location] = 0;
        }
        locationCounts[farmer.location]++;
      });
      
      // Sort locations by count
      const sortedLocations = Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1]);
      
      const labels = sortedLocations.map(([location]) => location);
      const data = sortedLocations.map(([, count]) => count);
      
      return { labels, data };
    }
    
    function prepareStatusData(orders) {
      // Count orders by status
      const statusCounts = {
        'Delivered': 0,
        'Processing': 0,
        'Pending': 0,
        'Cancelled': 0
      };
      
      orders.forEach(order => {
        if (statusCounts[order.status] !== undefined) {
          statusCounts[order.status]++;
        }
      });
      
      const labels = Object.keys(statusCounts);
      const data = Object.values(statusCounts);
      
      return { labels, data };
    }
    
    // Initialize sample data if empty
    function initializeSampleData() {
      const user = getCurrentUser();
      if (!user) return;
      
      const ordersKey = `supplier_orders_${user.id}`;
      const productsKey = `supplier_products_${user.id}`;
      
      // Check if we already have orders
      if (!localStorage.getItem(ordersKey)) {
        // Create sample orders
        const sampleOrders = [
          {
            id: 1001,
            orderDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
            farmerId: 101,
            farmerName: 'Rajesh Kumar',
            farmerLocation: 'Punjab',
            items: [
              { productId: 1001, productName: 'Organic Fertilizer', quantity: 5, price: 450, total: 2250 },
              { productId: 1002, productName: 'Tomato Seeds', quantity: 3, price: 120, total: 360 }
            ],
            total: 2610,
            status: 'Delivered'
          },
          {
            id: 1002,
            orderDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 days ago
            farmerId: 102,
            farmerName: 'Anita Sharma',
            farmerLocation: 'Maharashtra',
            items: [
              { productId: 1003, productName: 'Irrigation Drip Kit', quantity: 1, price: 1200, total: 1200 }
            ],
            total: 1200,
            status: 'Processing'
          },
          {
            id: 1003,
            orderDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // 5 days ago
            farmerId: 103,
            farmerName: 'Suresh Patel',
            farmerLocation: 'Gujarat',
            items: [
              { productId: 1001, productName: 'Organic Fertilizer', quantity: 10, price: 450, total: 4500 },
              { productId: 1003, productName: 'Irrigation Drip Kit', quantity: 2, price: 1200, total: 2400 }
            ],
            total: 6900,
            status: 'Delivered'
          },
          {
            id: 1004,
            orderDate: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), // 10 days ago
            farmerId: 104,
            farmerName: 'Meena Reddy',
            farmerLocation: 'Telangana',
            items: [
              { productId: 1002, productName: 'Tomato Seeds', quantity: 5, price: 120, total: 600 }
            ],
            total: 600,
            status: 'Delivered'
          },
          {
            id: 1005,
            orderDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // 3 days ago
            farmerId: 101,
            farmerName: 'Rajesh Kumar',
            farmerLocation: 'Punjab',
            items: [
              { productId: 1001, productName: 'Organic Fertilizer', quantity: 3, price: 450, total: 1350 }
            ],
            total: 1350,
            status: 'Pending'
          },
          {
            id: 1006,
            orderDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), // 15 days ago
            farmerId: 105,
            farmerName: 'Vikram Singh',
            farmerLocation: 'Haryana',
            items: [
              { productId: 1002, productName: 'Tomato Seeds', quantity: 2, price: 120, total: 240 },
              { productId: 1003, productName: 'Irrigation Drip Kit', quantity: 1, price: 1200, total: 1200 }
            ],
            total: 1440,
            status: 'Cancelled'
          }
        ];
        
        localStorage.setItem(ordersKey, JSON.stringify(sampleOrders));
      }
      
      // Check if we already have products
      if (!localStorage.getItem(productsKey)) {
        // Create sample products (same as in catalog.html)
        const sampleProducts = [
          {
            id: 1001,
            name: 'Organic Fertilizer',
            category: 'Fertilizers',
            description: 'High-quality organic fertilizer for all types of crops. Improves soil health and increases yield.',
            price: 450,
            unit: 'kg',
            quantity: 100,
            image_url: 'https://images.unsplash.com/photo-1585314062604-1a357de8b000?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: user.id,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          },
          {
            id: 1002,
            name: 'Tomato Seeds',
            category: 'Seeds',
            description: 'High-yield tomato seeds resistant to common diseases. Perfect for both small and large farms.',
            price: 120,
            unit: 'packet',
            quantity: 50,
            image_url: 'https://images.unsplash.com/photo-1582515073490-39981397c445?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: user.id,
            created_at: new Date(Date.now() - 86400000).toISOString(),
            updated_at: new Date(Date.now() - 86400000).toISOString()
          },
          {
            id: 1003,
            name: 'Irrigation Drip Kit',
            category: 'Equipment',
            description: 'Complete drip irrigation kit for efficient water usage. Easy to install and maintain.',
            price: 1200,
            unit: 'piece',
            quantity: 15,
            image_url: 'https://images.unsplash.com/photo-1563514227147-6d2e624f82b8?w=300&h=200&fit=crop',
            status: 'available',
            supplier_id: user.id,
            created_at: new Date(Date.now() - 172800000).toISOString(),
            updated_at: new Date(Date.now() - 172800000).toISOString()
          }
        ];
        
        localStorage.setItem(productsKey, JSON.stringify(sampleProducts));
      }
    }
    
    // Handle period filter clicks
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        updateStats();
      });
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      if (!protectPage('supplier')) return;
      
      // Initialize sample data if needed
      initializeSampleData();
      
      // Update stats and charts
      updateStats();
    });
  </script>
</body>
</html>