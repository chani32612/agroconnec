<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect ‚Äì Supplier Profile</title>
  <script src="/auth.js"></script>
  <script src="/supplier-products.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
    .profile-card { background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); overflow:hidden; }
    .profile-header { background:linear-gradient(135deg, #375432, #4a6b3a); color:white; padding:26px 20px; text-align:center; }
    .profile-avatar { width:92px; height:92px; border-radius:50%; background:rgba(255,255,255,0.2); margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2.2em; }
    .profile-content { padding: 20px; }
    .section-title { font-size:1.15em; font-weight:700; color:#375432; margin: 12px 0; border-bottom:2px solid #375432; padding-bottom:6px; }
    .form-row { display:flex; gap:12px; }
    .form-group { flex:1; margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:2px solid #ddd; border-radius:6px; font-family:'Georgia', serif; }
    .save-btn { background:#375432; color:white; border:none; border-radius:8px; padding:12px 16px; width:100%; cursor:pointer; margin-top:8px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; }
    .stat-card { background:#f8f9fa; padding:14px; border-radius:8px; text-align:center; }
    .stat-number { font-size:1.8em; font-weight:700; color:#375432; }
    .danger-zone { background:#fff5f5; border:2px solid #fed7d7; border-radius:8px; padding:14px; margin-top:18px; }
    .delete-btn { background:#dc3545;color:#fff;border:none;padding:.7rem 1rem;border-radius:6px;cursor:pointer; }
    .tag-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .tag { background:#e9f5e9; color:#375432; padding:6px 12px; border-radius:20px; font-size:0.9em; }
    .add-tag-btn { background:#375432; color:white; border:none; border-radius:20px; padding:6px 12px; cursor:pointer; font-size:0.9em; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">üè≠</div>
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-role">Supplier</div>
      </div>
      <div class="profile-content">
        <div class="section-title">Business Overview</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="total-products">0</div><div>Products</div></div>
          <div class="stat-card"><div class="stat-number" id="total-sales">‚Çπ0</div><div>Total Sales</div></div>
          <div class="stat-card"><div class="stat-number" id="total-customers">0</div><div>Customers</div></div>
        </div>

        <div class="section-title">Company Information</div>
        <form id="profile-form">
          <div class="form-row">
            <div class="form-group"><label for="company-name">Company Name</label><input id="company-name" required></div>
            <div class="form-group"><label for="email">Business Email</label><input id="email" type="email" required readonly></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="phone">Business Phone</label><input id="phone" type="tel"></div>
            <div class="form-group"><label for="website">Website</label><input id="website" type="url" placeholder="https://"></div>
          </div>
          <div class="form-group"><label for="business-description">Business Description</label><textarea id="business-description" rows="3" placeholder="Describe your business and the products you supply"></textarea></div>
          <div class="form-group"><label for="address">Business Address</label><textarea id="address" placeholder="Enter your complete business address"></textarea></div>
          <div class="form-row">
            <div class="form-group"><label for="city">City</label><input id="city"></div>
            <div class="form-group"><label for="state">State</label><input id="state"></div>
            <div class="form-group"><label for="pincode">PIN Code</label><input id="pincode"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="gst-number">GST Number</label><input id="gst-number" placeholder="22AAAAA0000A1Z5"></div>
            <div class="form-group"><label for="pan-number">PAN Number</label><input id="pan-number" placeholder="AAAAA0000A"></div>
          </div>
        </form>

        <div class="section-title">Product Categories</div>
        <div class="form-group">
          <label>Categories you supply</label>
          <div class="tag-list" id="category-tags">
            <!-- Tags will be added here by JavaScript -->
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <input id="new-category" placeholder="Add a new category" style="flex:1">
            <button class="add-tag-btn" onclick="addCategory()">Add</button>
          </div>
        </div>

        <div class="section-title">Business Preferences</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:10px;">
          <label><input type="checkbox" id="bulk-orders"> Accept Bulk Orders</label>
          <label><input type="checkbox" id="direct-delivery"> Direct Delivery Available</label>
          <label><input type="checkbox" id="organic-certified"> Organic Certified</label>
          <label><input type="checkbox" id="email-notifications"> Email Notifications</label>
          <label><input type="checkbox" id="order-alerts"> New Order Alerts</label>
          <label><input type="checkbox" id="price-updates"> Auto Price Updates</label>
        </div>

        <button class="save-btn" onclick="saveProfile()">Save Changes</button>

        <div class="danger-zone">
          <div style="font-weight:700;color:#c53030;margin-bottom:8px;">Danger Zone</div>
          <p>Once you delete your account, there is no going back. Please be certain.</p>
          <button class="delete-btn" onclick="deleteAccount()">Delete Account</button>
        </div>
      </div>
    </div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    function loadProfile(){
      const user = getCurrentUser(); if(!user) return;
      document.getElementById('profile-name').textContent = user.details?.company_name || user.username;
      document.getElementById('email').value = user.email;
      const name = user.details?.company_name || user.username; 
      document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();
      
      const key = `supplier_profile_${user.id}`; 
      const saved = JSON.parse(localStorage.getItem(key) || '{}');
      
      const set = (id, val)=>{ 
        const el=document.getElementById(id); 
        if(el){ el.type==='checkbox' ? (el.checked=!!val) : (el.value = val||''); }
      };
      
      set('company-name', saved.companyName || (user.details?.company_name||''));
      set('phone', saved.phone || user.details?.phone);
      set('website', saved.website);
      set('business-description', saved.businessDescription);
      set('address', saved.address || user.details?.address);
      set('city', saved.city);
      set('state', saved.state);
      set('pincode', saved.pincode);
      set('gst-number', saved.gstNumber);
      set('pan-number', saved.panNumber);
      
      set('bulk-orders', saved.bulkOrders);
      set('direct-delivery', saved.directDelivery);
      set('organic-certified', saved.organicCertified);
      set('email-notifications', saved.emailNotifications);
      set('order-alerts', saved.orderAlerts);
      set('price-updates', saved.priceUpdates);
      
      // Load categories
      const categories = saved.categories || [];
      renderCategories(categories);
      
      // Load stats
      const products = JSON.parse(localStorage.getItem(`supplier_products_${user.id}`) || '[]');
      document.getElementById('total-products').textContent = products.length;
      
      const orders = JSON.parse(localStorage.getItem(`supplier_orders_${user.id}`) || '[]');
      const totalSales = orders.reduce((s,o)=> s + (o.total||0), 0);
      document.getElementById('total-sales').textContent = `‚Çπ${totalSales.toFixed(0)}`;
      
      // Count unique customers
      const uniqueCustomers = new Set(orders.map(o => o.customerId));
      document.getElementById('total-customers').textContent = uniqueCustomers.size;
    }

    function renderCategories(categories) {
      const container = document.getElementById('category-tags');
      container.innerHTML = '';
      
      categories.forEach(category => {
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `${category} <span onclick="removeCategory('${category}')" style="cursor:pointer;margin-left:5px;">‚úï</span>`;
        container.appendChild(tag);
      });
    }
    
    function addCategory() {
      const input = document.getElementById('new-category');
      const category = input.value.trim();
      if (!category) return;
      
      const user = getCurrentUser(); if(!user) return;
      const key = `supplier_profile_${user.id}`;
      const saved = JSON.parse(localStorage.getItem(key) || '{}');
      
      const categories = saved.categories || [];
      if (!categories.includes(category)) {
        categories.push(category);
        saved.categories = categories;
        localStorage.setItem(key, JSON.stringify(saved));
        renderCategories(categories);
      }
      
      input.value = '';
    }
    
    function removeCategory(category) {
      const user = getCurrentUser(); if(!user) return;
      const key = `supplier_profile_${user.id}`;
      const saved = JSON.parse(localStorage.getItem(key) || '{}');
      
      const categories = saved.categories || [];
      const index = categories.indexOf(category);
      if (index !== -1) {
        categories.splice(index, 1);
        saved.categories = categories;
        localStorage.setItem(key, JSON.stringify(saved));
        renderCategories(categories);
      }
    }

    function saveProfile(){
      const user = getCurrentUser(); if(!user) return;
      const get = (id)=>{ const el=document.getElementById(id); return el.type==='checkbox'? el.checked : el.value; };
      
      const key = `supplier_profile_${user.id}`;
      const saved = JSON.parse(localStorage.getItem(key) || '{}');
      
      const profile = {
        companyName: get('company-name'),
        email: get('email'),
        phone: get('phone'),
        website: get('website'),
        businessDescription: get('business-description'),
        address: get('address'),
        city: get('city'),
        state: get('state'),
        pincode: get('pincode'),
        gstNumber: get('gst-number'),
        panNumber: get('pan-number'),
        bulkOrders: get('bulk-orders'),
        directDelivery: get('direct-delivery'),
        organicCertified: get('organic-certified'),
        emailNotifications: get('email-notifications'),
        orderAlerts: get('order-alerts'),
        priceUpdates: get('price-updates'),
        categories: saved.categories || []
      };
      
      localStorage.setItem(key, JSON.stringify(profile));
      alert('Profile saved successfully!');
    }

    function deleteAccount(){
      if(!confirm('Delete your supplier account? This cannot be undone.')) return;
      const user = getCurrentUser();
      if(!user) return;
      localStorage.removeItem('currentUser');
      alert('Account deleted (demo).');
      window.location.href='/index.html';
    }

    function initializeSampleData() {
      const user = getCurrentUser();
      if (!user) return;
      
      // Check if profile exists
      const key = `supplier_profile_${user.id}`;
      const saved = JSON.parse(localStorage.getItem(key) || '{}');
      
      if (!saved.categories) {
        // Add sample categories
        saved.categories = ['Fertilizers', 'Pesticides', 'Seeds', 'Farm Equipment', 'Irrigation Systems'];
        localStorage.setItem(key, JSON.stringify(saved));
      }
      
      // Check if products exist
      const products = JSON.parse(localStorage.getItem(`supplier_products_${user.id}`) || '[]');
      if (products.length === 0) {
        // Add sample products
        const sampleProducts = [
          { id: 'sp1', name: 'Organic Fertilizer', price: 450, stock: 100, category: 'Fertilizers', description: 'Natural organic fertilizer for all crops' },
          { id: 'sp2', name: 'Bio Pesticide', price: 350, stock: 50, category: 'Pesticides', description: 'Eco-friendly pest control solution' },
          { id: 'sp3', name: 'Hybrid Tomato Seeds', price: 120, stock: 200, category: 'Seeds', description: 'High-yield tomato variety' },
          { id: 'sp4', name: 'Drip Irrigation Kit', price: 1200, stock: 30, category: 'Irrigation Systems', description: 'Complete drip irrigation system for small farms' },
          { id: 'sp5', name: 'Hand Tiller', price: 850, stock: 15, category: 'Farm Equipment', description: 'Manual tilling tool for small plots' }
        ];
        localStorage.setItem(`supplier_products_${user.id}`, JSON.stringify(sampleProducts));
      }
      
      // Check if orders exist
      const orders = JSON.parse(localStorage.getItem(`supplier_orders_${user.id}`) || '[]');
      if (orders.length === 0) {
        // Add sample orders
        const sampleOrders = [
          {
            id: 's1001',
            customerId: 'farmer123',
            customerName: 'Rajesh Kumar',
            customerAddress: '123 Farm Road, Nashik, Maharashtra',
            customerPhone: '9876543210',
            orderDate: new Date(Date.now() - 86400000 * 2).toISOString(), // 2 days ago
            status: 'delivered',
            items: [
              {productId: 'sp1', productName: 'Organic Fertilizer', quantity: 5, price: 450, total: 2250},
              {productId: 'sp3', productName: 'Hybrid Tomato Seeds', quantity: 3, price: 120, total: 360}
            ],
            total: 2610
          },
          {
            id: 's1002',
            customerId: 'farmer456',
            customerName: 'Anita Singh',
            customerAddress: '456 Green Fields, Pune, Maharashtra',
            customerPhone: '8765432109',
            orderDate: new Date(Date.now() - 86400000 * 5).toISOString(), // 5 days ago
            status: 'shipped',
            items: [
              {productId: 'sp4', productName: 'Drip Irrigation Kit', quantity: 1, price: 1200, total: 1200}
            ],
            total: 1200
          },
          {
            id: 's1003',
            customerId: 'farmer789',
            customerName: 'Suresh Patel',
            customerAddress: '789 Harvest Lane, Ahmedabad, Gujarat',
            customerPhone: '7654321098',
            orderDate: new Date(Date.now() - 86400000 * 10).toISOString(), // 10 days ago
            status: 'delivered',
            items: [
              {productId: 'sp2', productName: 'Bio Pesticide', quantity: 2, price: 350, total: 700},
              {productId: 'sp5', productName: 'Hand Tiller', quantity: 1, price: 850, total: 850}
            ],
            total: 1550
          }
        ];
        localStorage.setItem(`supplier_orders_${user.id}`, JSON.stringify(sampleOrders));
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      if(!protectPage('supplier')) return;
      initializeSampleData();
      loadProfile();
    });
  </script>
</body>
</html>