<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect – Farmer Orders</title>
  <script src="/auth.js"></script>
  <script src="/farmer-products.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width:1100px; margin: 20px auto; padding: 0 20px; }
    .filter-tabs { display:flex; gap:10px; margin: 10px 0 18px; flex-wrap:wrap; }
    .filter-tab { background:#fff; border:2px solid #375432; color:#375432; padding:.45rem .8rem; border-radius:8px; cursor:pointer; }
    .filter-tab.active { background:#375432; color:#fff; }
    .order-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:14px; overflow:hidden; }
    .order-header { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .order-status { padding:.25rem .6rem; border-radius:12px; font-size:.85em; font-weight:700; }
    .status-pending { background:#fff3cd; color:#856404; }
    .status-confirmed { background:#d4edda; color:#155724; }
    .status-delivered { background:#d1ecf1; color:#0c5460; }
    .status-cancelled { background:#f8d7da; color:#721c24; }
    .order-items { padding: 14px 16px; }
    .order-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #f0f0f0; }
    .order-item:last-child { border-bottom:none; }
    .item-image { width:60px;height:60px;border-radius:6px;object-fit:cover; }
    .item-details { flex:1; }
    .total-row { background:#f8f9fa; padding: 12px 16px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .order-actions { display:flex; gap:8px; }
    .action-btn { border:none; border-radius:6px; padding:.45rem .8rem; cursor:pointer; }
    .confirm-btn { background:#28a745; color:#fff; }
    .reject-btn { background:#dc3545; color:#fff; }
    .ship-btn { background:#375432; color:#fff; }
    .customer-info { padding:12px 16px; background:#f8f9fa; border-top:1px solid #eee; }
    .empty { text-align:center; color:#666; padding:40px 20px; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <h1>Manage Orders</h1>
    <div class="filter-tabs">
      <div class="filter-tab active" data-filter="all">All</div>
      <div class="filter-tab" data-filter="pending">Pending</div>
      <div class="filter-tab" data-filter="confirmed">Confirmed</div>
      <div class="filter-tab" data-filter="delivered">Delivered</div>
      <div class="filter-tab" data-filter="cancelled">Cancelled</div>
    </div>

    <div id="orders-content"></div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    let currentFilter = 'all';
    function getOrders(){ 
      const user = getCurrentUser(); 
      if(!user) return []; 
      // In a real app, we would fetch orders for this farmer's products
      // For demo, we'll create some sample orders
      const savedOrders = localStorage.getItem(`farmer_orders_${user.id}`);
      if(savedOrders) {
        return JSON.parse(savedOrders);
      }
      
      // Generate sample orders if none exist
      const sampleOrders = [
        {
          id: 1001,
          customerId: 'cust123',
          customerName: 'Rahul Sharma',
          customerAddress: '123 Main St, Bangalore, Karnataka',
          customerPhone: '9876543210',
          orderDate: new Date(Date.now() - 86400000 * 2).toISOString(), // 2 days ago
          status: 'pending',
          items: [
            {productId: 'p1', productName: 'Organic Tomatoes', quantity: 5, price: 40, total: 200},
            {productId: 'p2', productName: 'Fresh Spinach', quantity: 2, price: 30, total: 60}
          ],
          total: 260
        },
        {
          id: 1002,
          customerId: 'cust456',
          customerName: 'Priya Patel',
          customerAddress: '456 Park Ave, Mumbai, Maharashtra',
          customerPhone: '8765432109',
          orderDate: new Date(Date.now() - 86400000 * 5).toISOString(), // 5 days ago
          status: 'confirmed',
          items: [
            {productId: 'p3', productName: 'Organic Rice', quantity: 10, price: 60, total: 600}
          ],
          total: 600
        },
        {
          id: 1003,
          customerId: 'cust789',
          customerName: 'Amit Kumar',
          customerAddress: '789 Lake View, Chennai, Tamil Nadu',
          customerPhone: '7654321098',
          orderDate: new Date(Date.now() - 86400000 * 10).toISOString(), // 10 days ago
          status: 'delivered',
          items: [
            {productId: 'p4', productName: 'Fresh Mangoes', quantity: 12, price: 50, total: 600},
            {productId: 'p5', productName: 'Organic Wheat', quantity: 5, price: 45, total: 225}
          ],
          total: 825
        }
      ];
      
      localStorage.setItem(`farmer_orders_${user.id}`, JSON.stringify(sampleOrders));
      return sampleOrders;
    }
    
    function saveOrders(orders){ 
      const user = getCurrentUser(); 
      if(!user) return; 
      localStorage.setItem(`farmer_orders_${user.id}`, JSON.stringify(orders)); 
    }

    function renderOrders(){
      const orders = getOrders();
      const wrap = document.getElementById('orders-content');
      let filtered = orders;
      if(currentFilter !== 'all') filtered = orders.filter(o => o.status === currentFilter);
      filtered.sort((a,b) => new Date(b.orderDate) - new Date(a.orderDate));
      
      if(filtered.length === 0){ 
        wrap.innerHTML = `<div class='empty'><h3>${currentFilter === 'all' ? 'No orders yet' : `No ${currentFilter} orders`}</h3><p>When customers order your products, they will appear here.</p></div>`; 
        return; 
      }
      
      wrap.innerHTML = filtered.map(order => {
        const itemsHTML = order.items.map(item => `<div class='order-item'>
            <img class='item-image' src='https://images.unsplash.com/photo-1560493676-04071c5f467b?w=60&h=60&fit=crop' alt='${item.productName}'>
            <div class='item-details'><div style='font-weight:700;'>${item.productName}</div></div>
            <div>${item.quantity} × ₹${item.price}</div>
          </div>`).join('');
          
        return `<div class='order-card'>
          <div class='order-header'>
            <div><div style='font-weight:700;'>Order #${order.id}</div><div style='color:#666;font-size:.9em;'>${new Date(order.orderDate).toLocaleString()}</div></div>
            <div class='order-status status-${order.status}'>${order.status[0].toUpperCase() + order.status.slice(1)}</div>
          </div>
          <div class='order-items'>${itemsHTML}</div>
          <div class='customer-info'>
            <div style='font-weight:700;'>Customer Information</div>
            <div>${order.customerName}</div>
            <div>${order.customerAddress}</div>
            <div>Phone: ${order.customerPhone}</div>
          </div>
          <div class='total-row'>
            <div style='font-weight:700;'>Total: ₹${order.total.toFixed(2)}</div>
            <div class='order-actions'>
              ${order.status === 'pending' ? `<button class='action-btn confirm-btn' onclick='confirmOrder(${order.id})'>Confirm</button><button class='action-btn reject-btn' onclick='rejectOrder(${order.id})'>Reject</button>` : ''}
              ${order.status === 'confirmed' ? `<button class='action-btn ship-btn' onclick='shipOrder(${order.id})'>Mark Shipped</button>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function confirmOrder(id){
      const orders = getOrders();
      const idx = orders.findIndex(x => x.id === id);
      if(idx !== -1){
        orders[idx].status = 'confirmed';
        saveOrders(orders);
        renderOrders();
        alert('Order confirmed successfully!');
      }
    }
    
    function rejectOrder(id){
      const orders = getOrders();
      const idx = orders.findIndex(x => x.id === id);
      if(idx !== -1){
        if(confirm('Are you sure you want to reject this order?')){
          orders[idx].status = 'cancelled';
          saveOrders(orders);
          renderOrders();
          alert('Order rejected.');
        }
      }
    }
    
    function shipOrder(id){
      const orders = getOrders();
      const idx = orders.findIndex(x => x.id === id);
      if(idx !== -1){
        orders[idx].status = 'delivered';
        saveOrders(orders);
        renderOrders();
        alert('Order marked as shipped!');
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      if(!protectPage('farmer')) return;
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          e.currentTarget.classList.add('active');
          currentFilter = e.currentTarget.dataset.filter;
          renderOrders();
        });
      });
      renderOrders();
    });
  </script>
</body>
</html>