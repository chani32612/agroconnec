<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroConnect – Farmer Messages</title>
  <script src="/auth.js"></script>
  <script src="/farmer-products.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; }

    .compose { display:flex; gap:10px; flex-wrap: wrap; align-items:flex-end; }
    .compose select, .compose textarea { border:1.5px solid #86b691; border-radius:8px; padding:10px; background:#ffffff; font-size:1em; }
    .compose select { min-width: 220px; }
    .compose textarea { flex:1; min-height: 70px; resize: vertical; }
    .compose button { background:#375432; color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer; }
    .compose button:hover { background:#20301d; }

    .messages { margin-top:16px; }
    .msg-list { display:flex; flex-direction:column; gap:10px; max-height: 55vh; overflow:auto; padding-right:4px; }
    .msg { display:flex; gap:10px; }
    .msg.you { justify-content:flex-end; }
    .bubble { max-width: 70%; background:#e6fbe3; border:1px solid #98e59d; color:#25632a; padding:10px 12px; border-radius:12px; }
    .msg.you .bubble { background:#375432; color:#fff; border-color:#375432; }
    .meta { font-size:.78em; color:#6f7e6d; margin-top:4px; }
    .empty { text-align:center; color:#666; padding:28px 10px; }
    .customer-list { margin-bottom: 16px; }
    .customer-item { padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }
    .customer-item:hover { background: #f0f7f0; }
    .customer-item.active { background: #e6fbe3; }
    .customer-avatar { width: 40px; height: 40px; border-radius: 50%; background: #375432; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .customer-info { flex: 1; }
    .unread-badge { background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
  </style>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="page-head">
      <h1 style="margin:0;">Messages</h1>
    </div>

    <div style="display: flex; gap: 16px;">
      <section class="card" style="flex: 0 0 300px;">
        <h3 style="margin:0 0 10px 0;">Customers</h3>
        <div id="customer-list" class="customer-list"></div>
      </section>

      <div style="flex: 1; display: flex; flex-direction: column;">
        <section class="card">
          <h3 style="margin:0 0 10px 0;">New message</h3>
          <div class="compose">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:.95em;">
              Recipient
              <select id="recipient">
                <option value="">Select a customer…</option>
              </select>
            </label>
            <label style="flex:1; display:flex; flex-direction:column; gap:6px; font-size:.95em;">
              Message
              <textarea id="messageText" placeholder="Type your message..."></textarea>
            </label>
            <button id="sendBtn">Send</button>
          </div>
        </section>

        <section class="messages card" style="margin-top:16px; flex: 1;">
          <h3 id="conversation-title" style="margin:0 0 10px 0;">Conversation</h3>
          <div id="messages" class="msg-list"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Shared footer -->
  <div data-include="/components/footer.html"></div>

  <script>
    const state = { 
      recipients: [], 
      user: null,
      selectedCustomer: null,
      customers: []
    };

    function messagesKey(userId){ return `farmer_messages_${userId}`; }
    function loadMessages(){
      const raw = localStorage.getItem(messagesKey(state.user.id));
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function saveMessages(list){ localStorage.setItem(messagesKey(state.user.id), JSON.stringify(list)); }

    async function loadRecipients(){
      // Try local cache first
      let data = null;
      try { data = JSON.parse(localStorage.getItem('userData') || 'null'); } catch {}
      if(!data){
        try {
          const res = await fetch('/dataa.json');
          data = await res.json();
          localStorage.setItem('userData', JSON.stringify(data));
        } catch(e){ console.warn('Failed to load userData', e); }
      }
      const consumers = (data?.users || []).filter(u => u.role === 'consumer');
      const consumerDetails = data?.consumers || [];
      state.recipients = consumers.map(c => {
        const d = consumerDetails.find(x => x.user_id === c.id);
        return { id: c.id, name: d?.full_name || c.username };
      });
      
      // If no consumers in data, create sample ones
      if (state.recipients.length === 0) {
        state.recipients = [
          { id: 101, name: 'Rahul Sharma' },
          { id: 102, name: 'Priya Patel' },
          { id: 103, name: 'Amit Kumar' }
        ];
      }
      
      const sel = document.getElementById('recipient');
      sel.innerHTML = '<option value="">Select a customer…</option>' + state.recipients.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      
      // Load customer list with message counts
      loadCustomerList();
    }
    
    function loadCustomerList() {
      const messages = loadMessages();
      const customerMap = new Map();
      
      // Group messages by customer
      messages.forEach(msg => {
        const customerId = msg.fromId === state.user.id ? msg.toId : msg.fromId;
        const customerName = msg.fromId === state.user.id ? msg.toName : msg.fromName;
        
        if (!customerMap.has(customerId)) {
          customerMap.set(customerId, {
            id: customerId,
            name: customerName,
            messages: [],
            unread: 0
          });
        }
        
        const customer = customerMap.get(customerId);
        customer.messages.push(msg);
        
        // Count unread messages (from customer to farmer)
        if (msg.fromId !== state.user.id && !msg.read) {
          customer.unread++;
        }
      });
      
      // Add customers from recipients who don't have messages yet
      state.recipients.forEach(r => {
        if (!customerMap.has(r.id)) {
          customerMap.set(r.id, {
            id: r.id,
            name: r.name,
            messages: [],
            unread: 0
          });
        }
      });
      
      state.customers = Array.from(customerMap.values());
      
      // Sort by most recent message
      state.customers.sort((a, b) => {
        const aLatest = a.messages.length > 0 ? new Date(a.messages[a.messages.length - 1].ts) : new Date(0);
        const bLatest = b.messages.length > 0 ? new Date(b.messages[b.messages.length - 1].ts) : new Date(0);
        return bLatest - aLatest;
      });
      
      renderCustomerList();
    }
    
    function renderCustomerList() {
      const listEl = document.getElementById('customer-list');
      
      if (state.customers.length === 0) {
        listEl.innerHTML = '<div class="empty">No customers yet.</div>';
        return;
      }
      
      listEl.innerHTML = state.customers.map(customer => {
        const isActive = state.selectedCustomer && state.selectedCustomer.id === customer.id;
        const initials = customer.name.split(' ').map(n => n[0]).join('').toUpperCase();
        
        return `<div class="customer-item ${isActive ? 'active' : ''}" data-id="${customer.id}">
          <div class="customer-avatar">${initials}</div>
          <div class="customer-info">
            <div>${customer.name}</div>
            <div style="font-size: 0.8em; color: #666;">${customer.messages.length > 0 ? 'Last message: ' + new Date(customer.messages[customer.messages.length - 1].ts).toLocaleDateString() : 'No messages'}</div>
          </div>
          ${customer.unread > 0 ? `<div class="unread-badge">${customer.unread}</div>` : ''}
        </div>`;
      }).join('');
      
      // Add click handlers
      document.querySelectorAll('.customer-item').forEach(item => {
        item.addEventListener('click', () => {
          const customerId = parseInt(item.dataset.id, 10);
          selectCustomer(customerId);
        });
      });
    }
    
    function selectCustomer(customerId) {
      const customer = state.customers.find(c => c.id === customerId);
      if (!customer) return;
      
      state.selectedCustomer = customer;
      document.getElementById('recipient').value = customer.id;
      document.getElementById('conversation-title').textContent = `Conversation with ${customer.name}`;
      
      // Mark messages as read
      const messages = loadMessages();
      let hasUnread = false;
      
      messages.forEach(msg => {
        if (msg.fromId === customer.id && !msg.read) {
          msg.read = true;
          hasUnread = true;
        }
      });
      
      if (hasUnread) {
        saveMessages(messages);
        loadCustomerList(); // Refresh customer list to update unread counts
      }
      
      renderCustomerList();
      renderMessages();
    }

    function renderMessages(){
      const box = document.getElementById('messages');
      let list = loadMessages();
      
      // Filter messages for selected customer if one is selected
      if (state.selectedCustomer) {
        list = list.filter(m => 
          (m.fromId === state.user.id && m.toId === state.selectedCustomer.id) || 
          (m.toId === state.user.id && m.fromId === state.selectedCustomer.id)
        );
      }
      
      list.sort((a,b)=> new Date(a.ts) - new Date(b.ts));
      
      if(list.length === 0){ 
        box.innerHTML = '<div class="empty">No messages yet. Start a conversation above.</div>'; 
        return; 
      }
      
      box.innerHTML = list.map(m => {
        const you = m.fromId === state.user.id;
        const to = you ? `To ${m.toName}` : `From ${m.fromName}`;
        return `<div class="msg ${you ? 'you':''}">
          <div class="bubble">
            <div>${m.text.replace(/</g,'&lt;')}</div>
            <div class="meta">${to} • ${new Date(m.ts).toLocaleString()}</div>
          </div>
        </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    }

    function sendMessage(){
      const sel = document.getElementById('recipient');
      const ta = document.getElementById('messageText');
      const toId = parseInt(sel.value, 10);
      const text = (ta.value || '').trim();
      if(!toId){ alert('Please choose a recipient'); return; }
      if(!text){ alert('Message cannot be empty'); return; }
      const to = state.recipients.find(r => r.id === toId);
      const list = loadMessages();
      const msg = {
        id: Date.now(),
        fromId: state.user.id,
        fromName: (state.user.details?.full_name) || state.user.username,
        toRole: 'consumer',
        toId,
        toName: to?.name || `Customer ${toId}`,
        text,
        ts: new Date().toISOString(),
        read: true
      };
      list.push(msg);
      saveMessages(list);
      ta.value = '';
      
      // If this is a new customer, select them
      if (!state.selectedCustomer || state.selectedCustomer.id !== toId) {
        selectCustomer(toId);
      } else {
        renderMessages();
      }
      
      alert('Message sent successfully!');

      // Optional: simulate quick auto-reply from customer
      setTimeout(()=>{
        const reply = {
          id: Date.now()+1,
          fromId: toId,
          fromName: msg.toName,
          toRole: 'farmer',
          toId: state.user.id,
          toName: msg.fromName,
          text: 'Thank you for your message! I have a question about your products. 🌱',
          ts: new Date().toISOString(),
          read: false
        };
        const l2 = loadMessages(); l2.push(reply); saveMessages(l2); 
        loadCustomerList(); // Refresh customer list with new message
        if (state.selectedCustomer && state.selectedCustomer.id === toId) {
          reply.read = true; // Mark as read immediately if we're viewing this conversation
          saveMessages(l2);
          renderMessages();
        }
      }, 800);
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      if(!protectPage('farmer')) return;
      state.user = getCurrentUser();
      await loadRecipients();
      renderMessages();
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      
      // Select first customer if available
      if (state.customers.length > 0) {
        selectCustomer(state.customers[0].id);
      }
    });
  </script>
</body>
</html>