<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect ‚Äì Farmer Profile</title>
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
    .profile-card { background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); overflow:hidden; }
    .profile-header { background:linear-gradient(135deg, #375432, #4a6b3a); color:white; padding:26px 20px; text-align:center; }
    .profile-avatar { width:92px; height:92px; border-radius:50%; background:rgba(255,255,255,0.2); margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2.2em; }
    .profile-content { padding: 20px; }
    .section-title { font-size:1.15em; font-weight:700; color:#375432; margin: 12px 0; border-bottom:2px solid #375432; padding-bottom:6px; }
    .form-row { display:flex; gap:12px; }
    .form-group { flex:1; margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:2px solid #ddd; border-radius:6px; font-family:'Georgia', serif; }
    .save-btn { background:#375432; color:white; border:none; border-radius:8px; padding:12px 16px; width:100%; cursor:pointer; margin-top:8px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; }
    .stat-card { background:#f8f9fa; padding:14px; border-radius:8px; text-align:center; }
    .stat-number { font-size:1.8em; font-weight:700; color:#375432; }
    .danger-zone { background:#fff5f5; border:2px solid #fed7d7; border-radius:8px; padding:14px; margin-top:18px; }
    .delete-btn { background:#dc3545;color:#fff;border:none;padding:.7rem 1rem;border-radius:6px;cursor:pointer; }
    .farm-gallery { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px; margin-top:10px; }
    .farm-image { width:100%; height:100px; object-fit:cover; border-radius:6px; }
    .add-image { height:100px; border:2px dashed #ddd; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">üë®‚Äçüåæ</div>
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-role">Farmer</div>
      </div>
      <div class="profile-content">
        <div class="section-title">Farm Overview</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="total-products">0</div><div>Products Listed</div></div>
          <div class="stat-card"><div class="stat-number" id="total-sales">‚Çπ0</div><div>Total Sales</div></div>
          <div class="stat-card"><div class="stat-number" id="total-customers">0</div><div>Customers</div></div>
        </div>

        <div class="section-title">Personal Information</div>
        <form id="profile-form">
          <div class="form-row">
            <div class="form-group"><label for="full-name">Full Name</label><input id="full-name" required></div>
            <div class="form-group"><label for="email">Email</label><input id="email" type="email" required readonly></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="phone">Phone</label><input id="phone" type="tel"></div>
            <div class="form-group"><label for="date-of-birth">Date of Birth</label><input id="date-of-birth" type="date"></div>
          </div>
          <div class="form-group"><label for="address">Farm Address</label><textarea id="address" placeholder="Enter your farm address"></textarea></div>
          <div class="form-row">
            <div class="form-group"><label for="city">City</label><input id="city"></div>
            <div class="form-group"><label for="state">State</label><input id="state"></div>
            <div class="form-group"><label for="pincode">PIN Code</label><input id="pincode"></div>
          </div>
        </form>

        <div class="section-title">Farm Details</div>
        <div class="form-row">
          <div class="form-group">
            <label for="farm-name">Farm Name</label>
            <input id="farm-name" placeholder="Enter your farm name">
          </div>
          <div class="form-group">
            <label for="farm-size">Farm Size (in acres)</label>
            <input id="farm-size" type="number" min="0" step="0.1">
          </div>
        </div>
        <div class="form-group">
          <label for="farm-description">Farm Description</label>
          <textarea id="farm-description" rows="3" placeholder="Tell customers about your farm and growing practices"></textarea>
        </div>
        <div class="form-group">
          <label for="specialties">Specialties</label>
          <input id="specialties" placeholder="e.g., Organic Vegetables, Exotic Fruits, etc.">
        </div>
        
        <div class="section-title">Farm Gallery</div>
        <div class="farm-gallery" id="farm-gallery">
          <div class="add-image" onclick="addFarmImage()">+ Add Image</div>
        </div>

        <div class="section-title">Farming Practices</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:10px;">
          <label><input type="checkbox" id="organic-certified"> Organic Certified</label>
          <label><input type="checkbox" id="pesticide-free"> Pesticide Free</label>
          <label><input type="checkbox" id="non-gmo"> Non-GMO</label>
          <label><input type="checkbox" id="sustainable"> Sustainable Practices</label>
          <label><input type="checkbox" id="traditional"> Traditional Methods</label>
          <label><input type="checkbox" id="hydroponic"> Hydroponic</label>
        </div>

        <button class="save-btn" onclick="saveProfile()">Save Changes</button>

        <div class="danger-zone">
          <div style="font-weight:700;color:#c53030;margin-bottom:8px;">Danger Zone</div>
          <p>Once you delete your account, there is no going back. Please be certain.</p>
          <button class="delete-btn" onclick="deleteAccount()">Delete Account</button>
        </div>
      </div>
    </div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    function loadProfile(){
      const user = getCurrentUser(); if(!user) return;
      document.getElementById('profile-name').textContent = user.details?.full_name || user.username;
      document.getElementById('email').value = user.email;
      const name = user.details?.full_name || user.username; document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();
      const key = `farmer_profile_${user.id}`; const saved = JSON.parse(localStorage.getItem(key) || '{}');
      const set = (id, val)=>{ const el=document.getElementById(id); if(el){ el.type==='checkbox' ? (el.checked=!!val) : (el.value = val||''); }};
      set('full-name', saved.fullName || (user.details?.full_name||'')); set('phone', saved.phone); set('date-of-birth', saved.dob); set('address', saved.address || user.details?.address); set('city', saved.city); set('state', saved.state); set('pincode', saved.pincode);
      set('farm-name', saved.farmName); set('farm-size', saved.farmSize); set('farm-description', saved.farmDescription); set('specialties', saved.specialties);
      set('organic-certified', saved.organicCertified); set('pesticide-free', saved.pesticideFree); set('non-gmo', saved.nonGmo); set('sustainable', saved.sustainable); set('traditional', saved.traditional); set('hydroponic', saved.hydroponic);
      
      // Load farm gallery images
      if (saved.farmImages && saved.farmImages.length > 0) {
        const gallery = document.getElementById('farm-gallery');
        saved.farmImages.forEach(img => {
          const imgEl = document.createElement('img');
          imgEl.src = img;
          imgEl.className = 'farm-image';
          gallery.insertBefore(imgEl, gallery.firstChild);
        });
      }
      
      // Load farm statistics
      const products = JSON.parse(localStorage.getItem(`farmer_products_${user.id}`) || '[]');
      document.getElementById('total-products').textContent = products.length;
      
      const orders = JSON.parse(localStorage.getItem(`farmer_orders_${user.id}`) || '[]');
      const totalSales = orders.reduce((s,o)=> s + (o.total||0), 0);
      document.getElementById('total-sales').textContent = `‚Çπ${totalSales.toFixed(0)}`;
      
      const uniqueCustomers = new Set(orders.map(o => o.customerId));
      document.getElementById('total-customers').textContent = uniqueCustomers.size;
    }

    function saveProfile(){
      const user = getCurrentUser(); if(!user) return;
      const get = (id)=>{ const el=document.getElementById(id); return el.type==='checkbox'? el.checked : el.value; };
      const profile = {
        fullName: get('full-name'), email: get('email'), phone: get('phone'), dob: get('date-of-birth'), 
        address: get('address'), city: get('city'), state: get('state'), pincode: get('pincode'),
        farmName: get('farm-name'), farmSize: get('farm-size'), farmDescription: get('farm-description'), 
        specialties: get('specialties'),
        organicCertified: get('organic-certified'), pesticideFree: get('pesticide-free'), nonGmo: get('non-gmo'),
        sustainable: get('sustainable'), traditional: get('traditional'), hydroponic: get('hydroponic'),
        farmImages: Array.from(document.querySelectorAll('.farm-image')).map(img => img.src)
      };
      localStorage.setItem(`farmer_profile_${user.id}`, JSON.stringify(profile));
      alert('Profile saved successfully!');
    }

    function addFarmImage(){
      // In a real app, this would open a file picker and upload the image
      // For demo purposes, we'll just add a placeholder image
      const placeholderImages = [
        'https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80',
        'https://images.unsplash.com/photo-1464226184884-fa280b87c399?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80',
        'https://images.unsplash.com/photo-1500076656116-558758c991c1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'
      ];
      const randomImg = placeholderImages[Math.floor(Math.random() * placeholderImages.length)];
      
      const gallery = document.getElementById('farm-gallery');
      const imgEl = document.createElement('img');
      imgEl.src = randomImg;
      imgEl.className = 'farm-image';
      gallery.insertBefore(imgEl, gallery.firstChild);
    }

    function deleteAccount(){ 
      if(!confirm('Delete your account? This cannot be undone.')) return; 
      const user=getCurrentUser(); 
      if(!user) return; 
      localStorage.removeItem('currentUser'); 
      alert('Account deleted (demo).'); 
      window.location.href='/index.html'; 
    }

    document.addEventListener('DOMContentLoaded', function(){ 
      if(!protectPage('farmer')) return; 
      loadProfile(); 
    });
  </script>
</body>
</html>