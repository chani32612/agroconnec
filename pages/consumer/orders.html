<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect – Orders</title>
  <script src="/auth.js"></script>
  <script src="/consumer-products.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width:1100px; margin: 20px auto; padding: 0 20px; }
    .filter-tabs { display:flex; gap:10px; margin: 10px 0 18px; flex-wrap:wrap; }
    .filter-tab { background:#fff; border:2px solid #375432; color:#375432; padding:.45rem .8rem; border-radius:8px; cursor:pointer; }
    .filter-tab.active { background:#375432; color:#fff; }
    .order-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:14px; overflow:hidden; }
    .order-header { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .order-status { padding:.25rem .6rem; border-radius:12px; font-size:.85em; font-weight:700; }
    .status-pending { background:#fff3cd; color:#856404; }
    .status-confirmed { background:#d4edda; color:#155724; }
    .status-delivered { background:#d1ecf1; color:#0c5460; }
    .status-cancelled { background:#f8d7da; color:#721c24; }
    .order-items { padding: 14px 16px; }
    .order-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #f0f0f0; }
    .order-item:last-child { border-bottom:none; }
    .item-image { width:60px;height:60px;border-radius:6px;object-fit:cover; }
    .item-details { flex:1; }
    .total-row { background:#f8f9fa; padding: 12px 16px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .order-actions { display:flex; gap:8px; }
    .action-btn { border:none; border-radius:6px; padding:.45rem .8rem; cursor:pointer; }
    .track-btn { background:#375432; color:#fff; }
    .cancel-btn { background:#dc3545; color:#fff; }
    .reorder-btn { background:#28a745; color:#fff; }
    .empty { text-align:center; color:#666; padding:40px 20px; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <h1>My Orders</h1>
    <div class="filter-tabs">
      <div class="filter-tab active" data-filter="all">All</div>
      <div class="filter-tab" data-filter="pending">Pending</div>
      <div class="filter-tab" data-filter="confirmed">Confirmed</div>
      <div class="filter-tab" data-filter="delivered">Delivered</div>
      <div class="filter-tab" data-filter="cancelled">Cancelled</div>
    </div>

    <div id="orders-content"></div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    let currentFilter = 'all';
    function getOrders(){ const u=getCurrentUser(); if(!u) return []; return JSON.parse(localStorage.getItem(`orders_${u.id}`) || '[]'); }
    function saveOrders(o){ const u=getCurrentUser(); if(!u) return; localStorage.setItem(`orders_${u.id}`, JSON.stringify(o)); }

    function renderOrders(){
      const orders = getOrders();
      const wrap = document.getElementById('orders-content');
      let filtered = orders;
      if(currentFilter!=='all') filtered = orders.filter(o=>o.status===currentFilter);
      filtered.sort((a,b)=> new Date(b.orderDate)-new Date(a.orderDate));
      if(filtered.length===0){ wrap.innerHTML = `<div class='empty'><h3>${currentFilter==='all' ? 'No orders yet' : `No ${currentFilter} orders`}</h3><p>Start shopping for fresh products from local farmers!</p><a href='/pages/consumer/catalog.html' style='background:#375432;color:#fff;text-decoration:none;padding:.8rem 1.1rem;border-radius:8px;display:inline-block;margin-top:10px;'>Start Shopping</a></div>`; return; }
      wrap.innerHTML = filtered.map(order=>{
        const itemsHTML = order.items.map(item=>`<div class='order-item'>
            <img class='item-image' src='https://images.unsplash.com/photo-1560493676-04071c5f467b?w=60&h=60&fit=crop' alt='${item.productName}'>
            <div class='item-details'><div style='font-weight:700;'>${item.productName}</div><div style='color:#666;font-size:.9em;'>by ${item.farmerName}</div></div>
            <div>${item.quantity} × ₹${item.price}</div>
          </div>`).join('');
        return `<div class='order-card'>
          <div class='order-header'>
            <div><div style='font-weight:700;'>Order #${order.id}</div><div style='color:#666;font-size:.9em;'>${new Date(order.orderDate).toLocaleString()}</div></div>
            <div class='order-status status-${order.status}'>${order.status[0].toUpperCase()+order.status.slice(1)}</div>
          </div>
          <div class='order-items'>${itemsHTML}</div>
          <div class='total-row'>
            <div style='font-weight:700;'>Total: ₹${order.total.toFixed(2)}</div>
            <div class='order-actions'>
              ${order.status==='pending' ? `<button class='action-btn track-btn' onclick='trackOrder(${order.id})'>Track</button><button class='action-btn cancel-btn' onclick='cancelOrder(${order.id})'>Cancel</button>` : ''}
              ${order.status==='confirmed' ? `<button class='action-btn track-btn' onclick='trackOrder(${order.id})'>Track</button>` : ''}
              ${order.status==='delivered' ? `<button class='action-btn reorder-btn' onclick='reorder(${order.id})'>Reorder</button>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function trackOrder(id){ alert(`Tracking for order #${id} not implemented in frontend demo.`); }
    function cancelOrder(id){ const o=getOrders(); const idx=o.findIndex(x=>x.id===id); if(idx!==-1){ if(confirm('Cancel this order?')){ o[idx].status='cancelled'; saveOrders(o); renderOrders(); showConsumerNotification('Order cancelled','info'); } } }
    function reorder(id){ const o=getOrders(); const ord=o.find(x=>x.id===id); if(!ord) return; const u=getCurrentUser(); const cartKey=`cart_${u.id}`; const cart=JSON.parse(localStorage.getItem(cartKey)||'[]'); ord.items.forEach(it=>{ const existing=cart.find(c=>c.productId===it.productId && c.farmerId===it.farmerId); if(existing) existing.quantity+=it.quantity; else cart.push({...it}); }); localStorage.setItem(cartKey, JSON.stringify(cart)); showConsumerNotification('Items added to cart','success'); setTimeout(()=>{ window.location.href='/pages/consumer/cart.html'; }, 1000); }

    document.addEventListener('DOMContentLoaded', function(){ if(!protectPage('consumer')) return; document.querySelectorAll('.filter-tab').forEach(tab=>{ tab.addEventListener('click', (e)=>{ document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active')); e.currentTarget.classList.add('active'); currentFilter = e.currentTarget.dataset.filter; renderOrders(); }); }); renderOrders(); });
  </script>
</body>
</html>