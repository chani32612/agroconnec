<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect â€“ Profile</title>
  <script src="/auth.js"></script>
  <script src="/consumer-products.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
    .profile-card { background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); overflow:hidden; }
    .profile-header { background:linear-gradient(135deg, #375432, #4a6b3a); color:white; padding:26px 20px; text-align:center; }
    .profile-avatar { width:92px; height:92px; border-radius:50%; background:rgba(255,255,255,0.2); margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2.2em; }
    .profile-content { padding: 20px; }
    .section-title { font-size:1.15em; font-weight:700; color:#375432; margin: 12px 0; border-bottom:2px solid #375432; padding-bottom:6px; }
    .form-row { display:flex; gap:12px; }
    .form-group { flex:1; margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:2px solid #ddd; border-radius:6px; font-family:'Georgia', serif; }
    .save-btn { background:#375432; color:white; border:none; border-radius:8px; padding:12px 16px; width:100%; cursor:pointer; margin-top:8px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; }
    .stat-card { background:#f8f9fa; padding:14px; border-radius:8px; text-align:center; }
    .stat-number { font-size:1.8em; font-weight:700; color:#375432; }
    .danger-zone { background:#fff5f5; border:2px solid #fed7d7; border-radius:8px; padding:14px; margin-top:18px; }
    .delete-btn { background:#dc3545;color:#fff;border:none;padding:.7rem 1rem;border-radius:6px;cursor:pointer; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">ðŸ‘¤</div>
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-role">Consumer</div>
      </div>
      <div class="profile-content">
        <div class="section-title">Account Overview</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="total-orders">0</div><div>Total Orders</div></div>
          <div class="stat-card"><div class="stat-number" id="total-spent">â‚¹0</div><div>Total Spent</div></div>
          <div class="stat-card"><div class="stat-number" id="favorite-farmers">0</div><div>Favorite Farmers</div></div>
        </div>

        <div class="section-title">Personal Information</div>
        <form id="profile-form">
          <div class="form-row">
            <div class="form-group"><label for="full-name">Full Name</label><input id="full-name" required></div>
            <div class="form-group"><label for="email">Email</label><input id="email" type="email" required readonly></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="phone">Phone</label><input id="phone" type="tel"></div>
            <div class="form-group"><label for="date-of-birth">Date of Birth</label><input id="date-of-birth" type="date"></div>
          </div>
          <div class="form-group"><label for="address">Address</label><textarea id="address" placeholder="Enter your complete address"></textarea></div>
          <div class="form-row">
            <div class="form-group"><label for="city">City</label><input id="city"></div>
            <div class="form-group"><label for="state">State</label><input id="state"></div>
            <div class="form-group"><label for="pincode">PIN Code</label><input id="pincode"></div>
          </div>
        </form>

        <div class="section-title">Shopping Preferences</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:10px;">
          <label><input type="checkbox" id="organic-only"> Prefer Organic Products</label>
          <label><input type="checkbox" id="local-farmers"> Support Local Farmers</label>
          <label><input type="checkbox" id="seasonal-products"> Seasonal Products Only</label>
          <label><input type="checkbox" id="email-notifications"> Email Notifications</label>
          <label><input type="checkbox" id="price-alerts"> Price Drop Alerts</label>
          <label><input type="checkbox" id="new-farmer-alerts"> New Farmer Alerts</label>
        </div>

        <button class="save-btn" onclick="saveProfile()">Save Changes</button>

        <div class="danger-zone">
          <div style="font-weight:700;color:#c53030;margin-bottom:8px;">Danger Zone</div>
          <p>Once you delete your account, there is no going back. Please be certain.</p>
          <button class="delete-btn" onclick="deleteAccount()">Delete Account</button>
        </div>
      </div>
    </div>
  </main>

  <div data-include="/components/footer.html"></div>

  <script>
    function loadProfile(){
      const user = getCurrentUser(); if(!user) return;
      document.getElementById('profile-name').textContent = user.details?.full_name || user.username;
      document.getElementById('email').value = user.email;
      const name = user.details?.full_name || user.username; document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();
      const key = `profile_${user.id}`; const saved = JSON.parse(localStorage.getItem(key) || '{}');
      const set = (id, val)=>{ const el=document.getElementById(id); if(el){ el.type==='checkbox' ? (el.checked=!!val) : (el.value = val||''); }};
      set('full-name', saved.fullName || (user.details?.full_name||'')); set('phone', saved.phone); set('date-of-birth', saved.dob); set('address', saved.address || user.details?.address); set('city', saved.city); set('state', saved.state); set('pincode', saved.pincode);
      set('organic-only', saved.organicOnly); set('local-farmers', saved.localFarmers); set('seasonal-products', saved.seasonalOnly); set('email-notifications', saved.emailNotifications); set('price-alerts', saved.priceAlerts); set('new-farmer-alerts', saved.newFarmerAlerts);
      const orders = JSON.parse(localStorage.getItem(`orders_${user.id}`) || '[]');
      document.getElementById('total-orders').textContent = orders.length;
      const totalSpent = orders.reduce((s,o)=> s + (o.total||0), 0); document.getElementById('total-spent').textContent = `â‚¹${totalSpent.toFixed(0)}`;
      document.getElementById('favorite-farmers').textContent = saved.favoriteFarmers?.length || 0;
    }

    function saveProfile(){
      const user = getCurrentUser(); if(!user) return;
      const get = (id)=>{ const el=document.getElementById(id); return el.type==='checkbox'? el.checked : el.value; };
      const profile = {
        fullName: get('full-name'), email: get('email'), phone: get('phone'), dob: get('date-of-birth'), address: get('address'), city: get('city'), state: get('state'), pincode: get('pincode'),
        organicOnly: get('organic-only'), localFarmers: get('local-farmers'), seasonalOnly: get('seasonal-products'), emailNotifications: get('email-notifications'), priceAlerts: get('price-alerts'), newFarmerAlerts: get('new-farmer-alerts')
      };
      localStorage.setItem(`profile_${user.id}`, JSON.stringify(profile));
      showConsumerNotification('Profile saved','success');
    }

    function deleteAccount(){ if(!confirm('Delete your account? This cannot be undone.')) return; const user=getCurrentUser(); if(!user) return; localStorage.removeItem('currentUser'); alert('Account deleted (demo).'); window.location.href='/index.html'; }

    document.addEventListener('DOMContentLoaded', function(){ if(!protectPage('consumer')) return; loadProfile(); });
  </script>
</body>
</html>